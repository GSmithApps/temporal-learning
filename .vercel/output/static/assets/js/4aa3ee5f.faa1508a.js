"use strict";(self.webpackChunktemporal_learning=self.webpackChunktemporal_learning||[]).push([[4392],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=r.createContext({}),u=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},c=function(e){var t=u(e.components);return r.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=u(n),m=o,h=d["".concat(s,".").concat(m)]||d[m]||p[m]||i;return n?r.createElement(h,a(a({ref:t},c),{},{components:n})):r.createElement(h,a({ref:t},c))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,a=new Array(i);a[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,a[1]=l;for(var u=2;u<i;u++)a[u]=n[u];return r.createElement.apply(null,a)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},5162:(e,t,n)=>{n.d(t,{Z:()=>a});var r=n(7294),o=n(4334);const i="tabItem_Ymn6";function a(e){let{children:t,hidden:n,className:a}=e;return r.createElement("div",{role:"tabpanel",className:(0,o.Z)(i,a),hidden:n},t)}},4866:(e,t,n)=>{n.d(t,{Z:()=>E});var r=n(3117),o=n(7294),i=n(4334),a=n(6775),l=n(1980),s=n(7392),u=n(12);function c(e){return function(e){return o.Children.map(e,(e=>{if(!e||(0,o.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:t,label:n,attributes:r,default:o}}=e;return{value:t,label:n,attributes:r,default:o}}))}function p(e){const{values:t,children:n}=e;return(0,o.useMemo)((()=>{const e=t??c(n);return function(e){const t=(0,s.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function d(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function m(e){let{queryString:t=!1,groupId:n}=e;const r=(0,a.k6)(),i=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,l._X)(i),(0,o.useCallback)((e=>{if(!i)return;const t=new URLSearchParams(r.location.search);t.set(i,e),r.replace({...r.location,search:t.toString()})}),[i,r])]}function h(e){const{defaultValue:t,queryString:n=!1,groupId:r}=e,i=p(e),[a,l]=(0,o.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!d({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const r=n.find((e=>e.default))??n[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:t,tabValues:i}))),[s,c]=m({queryString:n,groupId:r}),[h,f]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[r,i]=(0,u.Nk)(n);return[r,(0,o.useCallback)((e=>{n&&i.set(e)}),[n,i])]}({groupId:r}),w=(()=>{const e=s??h;return d({value:e,tabValues:i})?e:null})();(0,o.useLayoutEffect)((()=>{w&&l(w)}),[w]);return{selectedValue:a,selectValue:(0,o.useCallback)((e=>{if(!d({value:e,tabValues:i}))throw new Error(`Can't select invalid tab value=${e}`);l(e),c(e),f(e)}),[c,f,i]),tabValues:i}}var f=n(2466),w=n(2389);const k="tabList__CuJ",b="tabItem_LNqP";function g(e){let{className:t,block:n,selectedValue:a,selectValue:l,tabValues:s}=e;const u=[],{blockElementScrollPositionUntilNextRender:c}=(0,f.o5)(),p=e=>{const t=e.currentTarget,n=u.indexOf(t),r=s[n].value;r!==a&&(c(t),l(r))},d=e=>{let t=null;switch(e.key){case"Enter":p(e);break;case"ArrowRight":{const n=u.indexOf(e.currentTarget)+1;t=u[n]??u[0];break}case"ArrowLeft":{const n=u.indexOf(e.currentTarget)-1;t=u[n]??u[u.length-1];break}}t?.focus()};return o.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.Z)("tabs",{"tabs--block":n},t)},s.map((e=>{let{value:t,label:n,attributes:l}=e;return o.createElement("li",(0,r.Z)({role:"tab",tabIndex:a===t?0:-1,"aria-selected":a===t,key:t,ref:e=>u.push(e),onKeyDown:d,onClick:p},l,{className:(0,i.Z)("tabs__item",b,l?.className,{"tabs__item--active":a===t})}),n??t)})))}function y(e){let{lazy:t,children:n,selectedValue:r}=e;const i=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=i.find((e=>e.props.value===r));return e?(0,o.cloneElement)(e,{className:"margin-top--md"}):null}return o.createElement("div",{className:"margin-top--md"},i.map(((e,t)=>(0,o.cloneElement)(e,{key:t,hidden:e.props.value!==r}))))}function v(e){const t=h(e);return o.createElement("div",{className:(0,i.Z)("tabs-container",k)},o.createElement(g,(0,r.Z)({},e,t)),o.createElement(y,(0,r.Z)({},e,t)))}function E(e){const t=(0,w.Z)();return o.createElement(v,(0,r.Z)({key:String(t)},e))}},75:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>a,default:()=>p,frontMatter:()=>i,metadata:()=>l,toc:()=>u});var r=n(3117),o=(n(7294),n(3905));n(5162),n(4866);const i={title:"Build an email subscription workflow with Temporal and Go",sidebar_position:3,keywords:["Go","tutorial","temporal","workflows","SDK","subscription"],description:"Implement an email subscription application in Go with Temporal's Workflows, Activities, and Queries, using the Temporal Client in a web API.",last_update:{date:new Date("2023-09-28T00:00:00.000Z")},image:"/img/temporal-logo-twitter-card.png"},a=void 0,l={unversionedId:"tutorials/go/subscriptions/index",id:"tutorials/go/subscriptions/index",title:"Build an email subscription workflow with Temporal and Go",description:"Implement an email subscription application in Go with Temporal's Workflows, Activities, and Queries, using the Temporal Client in a web API.",source:"@site/docs/tutorials/go/subscriptions/index.md",sourceDirName:"tutorials/go/subscriptions",slug:"/tutorials/go/subscriptions/",permalink:"/tutorials/go/subscriptions/",draft:!1,tags:[],version:"current",lastUpdatedAt:1695859200,formattedLastUpdatedAt:"Sep 28, 2023",sidebarPosition:3,frontMatter:{title:"Build an email subscription workflow with Temporal and Go",sidebar_position:3,keywords:["Go","tutorial","temporal","workflows","SDK","subscription"],description:"Implement an email subscription application in Go with Temporal's Workflows, Activities, and Queries, using the Temporal Client in a web API.",last_update:{date:"2023-09-28T00:00:00.000Z"},image:"/img/temporal-logo-twitter-card.png"},sidebar:"tutorialSidebar",previous:{title:"Building an eCommerce web app with Temporal and Go, Part 4: REST API",permalink:"/tutorials/go/ecommerce/build-an-ecommerce-app-with-temporal-part-4-rest-api"},next:{title:"TypeScript tutorials",permalink:"/tutorials/typescript/"}},s={},u=[{value:"Introduction",id:"introduction",level:3},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Develop the Workflow",id:"develop-the-workflow",level:2},{value:"Develop the Activities",id:"develop-the-activities",level:2},{value:"Build the Worker",id:"build-the-worker",level:2},{value:"Build the web server",id:"build-the-web-server",level:2},{value:"Add a Query",id:"add-a-query",level:2},{value:"Unsubscribe users with a Workflow Cancellation request",id:"unsubscribe-users-with-a-workflow-cancellation-request",level:2},{value:"Create integration tests",id:"create-integration-tests",level:2},{value:"Conclusion",id:"conclusion",level:2}],c={toc:u};function p(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h3",{id:"introduction"},"Introduction"),(0,o.kt)("p",null,"In this tutorial, you'll build an email subscription web application using Temporal and Go. You'll create a web server to handle requests, and use Temporal Workflows, Activities, and Queries to build the core of the application. Your web server will handle requests from the end user and interact with a Temporal Workflow to manage the email subscription process. Since you're building the business logic with Temporal's Workflows and Activities, you'll be able to use Temporal to manage each subscription rather than relying on a separate database or queue. This reduces the complexity of the code you have to write and support."),(0,o.kt)("p",null,"You'll create an endpoint for users to give their email address, and then create a new Workflow Execution using that email address which will simulate sending an email message at certain intervals. The user can check on the status of their subscription, which you'll handle using a Query, and they can end the subscription at any time by unsubscribing, which you'll handle by cancelling the Workflow Execution. You can view the user's entire process through Temporal's Web UI. For this tutorial, you'll simulate sending emails, but you can adapt this example to call a live email service in the future."),(0,o.kt)("p",null,"By the end of this tutorial, you'll have a clear understanding of how to use Temporal to create and manage long-running Workflows within a web application."),(0,o.kt)("p",null,"You'll find the code for this tutorial on GitHub in the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-go"},"email-subscription-project-go")," repository."),(0,o.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://learn.temporal.io/getting_started/go/dev_environment/"},"Set up a local development environment for Temporal and Go"),"."),(0,o.kt)("li",{parentName:"ul"},"Complete the ",(0,o.kt)("a",{parentName:"li",href:"https://learn.temporal.io/getting_started/go/hello_world_in_go/"},"Hello World")," to ensure you understand the basics of creating Workflows and Activities with Temporal."),(0,o.kt)("li",{parentName:"ul"},"Create a new directory for the project called ",(0,o.kt)("inlineCode",{parentName:"li"},"email-subscription-project"),"."),(0,o.kt)("li",{parentName:"ul"},"Run ",(0,o.kt)("inlineCode",{parentName:"li"},"go mod init subscribeemail")," to create a Go module file in the project directory."),(0,o.kt)("li",{parentName:"ul"},"Run ",(0,o.kt)("inlineCode",{parentName:"li"},"go mod tidy")," to update the Go module file.")),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"Always run ",(0,o.kt)("inlineCode",{parentName:"p"},"go mod tidy")," after importing new packages to the application.")),(0,o.kt)("h2",{id:"develop-the-workflow"},"Develop the Workflow"),(0,o.kt)("p",null,"A Workflow defines a sequence of steps defined by writing code, known as a ",(0,o.kt)("a",{parentName:"p",href:"https://docs.temporal.io/workflows#workflow-definition"},"Workflow Definition"),", and are carried out by running that code, which results in a Workflow Execution."),(0,o.kt)("p",null,"The Temporal Go SDK recommends the use of a single struct for parameters and return types. This lets you change fields without breaking Workflow compatibility.\nBefore writing the Workflow Definition, you'll define the data object used by the Workflow Definition."),(0,o.kt)("p",null,"To set up the struct, create a new file called ",(0,o.kt)("inlineCode",{parentName:"p"},"subscribe.go")," in your project directory. This file will hold some constants you'll use in the application."),(0,o.kt)("p",null,"This struct will represent the data you'll send to your Activity and Workflow.\nYou'll create an ",(0,o.kt)("inlineCode",{parentName:"p"},"EmailDetails")," struct with the following fields:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"EmailAddress"),": a string to pass a user's email"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Message"),": a string to pass a message to the user"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"IsSubscribed"),": a boolean to track whether the user is subscribed"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"SubscriptionCount"),": an integer to track the number of emails sent")),(0,o.kt)("p",null,"Add the following code to the ",(0,o.kt)("inlineCode",{parentName:"p"},"subscribe.go")," file to define the struct, as well as the Task Queue name and the host and port your web API will use:"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-go/blob/main/subscribe.go"},"subscribe.go")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'package subscribeemails\n\nconst TaskQueueName string = "email_subscription"\nconst ClientHostPort string = "localhost:4000"\n\ntype EmailDetails struct {\n    EmailAddress      string `json:"emailAddress"`\n    Message           string `json:"message"`\n    IsSubscribed      bool   `json:"isSubscribed"`\n    SubscriptionCount int    `json:"subscriptionCount"`\n}\n')),(0,o.kt)("p",null,"Now that you have your ",(0,o.kt)("inlineCode",{parentName:"p"},"EmailDetails")," struct defined, you can move on to writing the Workflow Definition."),(0,o.kt)("p",null,"To create a new Workflow Definition, create a new file called ",(0,o.kt)("inlineCode",{parentName:"p"},"workflow.go"),". This file will contain the ",(0,o.kt)("inlineCode",{parentName:"p"},"SubscriptionWorkflow()")," function."),(0,o.kt)("p",null,"Use the ",(0,o.kt)("inlineCode",{parentName:"p"},"workflow.go")," file to write deterministic logic inside your Workflow Definition and to execute the Activity."),(0,o.kt)("p",null,"Add the following code to define the Workflow:"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-go/blob/main/workflow.go"},"workflow.go")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'package subscribeemails\n\nimport (\n    "errors"\n    "time"\n\n    "go.temporal.io/sdk/workflow"\n)\n\n// Workflow definition\nfunc SubscriptionWorkflow(ctx workflow.Context, emailDetails EmailDetails) error {\n    duration := 12 * time.Second\n    logger := workflow.GetLogger(ctx)\n    logger.Info("Subscription created", "EmailAddress", emailDetails.EmailAddress)\n\n// ...\n    // variable for Activity Options. Timeout can be set to a longer timespan (such as a month)\n    ctx = workflow.WithActivityOptions(ctx, workflow.ActivityOptions{\n        StartToCloseTimeout: 2 * time.Minute,\n        WaitForCancellation: true,\n    })\n\n// ...\n    // handling for the first email ever\n    logger.Info("Sending welcome email", "EmailAddress", emailDetails.EmailAddress)\n    emailDetails.SubscriptionCount++\n    data := EmailDetails{\n        EmailAddress:      emailDetails.EmailAddress,\n        Message:           "Welcome! Looks like you\'ve been signed up!",\n        IsSubscribed:      true,\n        SubscriptionCount: emailDetails.SubscriptionCount,\n    }\n\n    // send welcome email, increment billing period\n    err = workflow.ExecuteActivity(ctx, SendEmail, data).Get(ctx, nil)\n    if err != nil {\n        return err\n    }\n\n    // start subscription period. execute until no longer subscribed\n    for emailDetails.IsSubscribed {\n        emailDetails.SubscriptionCount++\n        data := EmailDetails{\n            EmailAddress:      emailDetails.EmailAddress,\n            Message:           "This is yet another email in the Subscription Workflow.",\n            IsSubscribed:      true,\n            SubscriptionCount: emailDetails.SubscriptionCount,\n        }\n\n        err = workflow.ExecuteActivity(ctx, SendEmail, data).Get(ctx, nil)\n        if err != nil {\n            return err\n        }\n        logger.Info("Sent content email", "EmailAddress", emailDetails.EmailAddress)\n        // Sleep the Workflow until the next subscription email needs to be sent.\n        // This can be set to sleep every month between emails.\n        if err = workflow.Sleep(ctx, duration); err != nil {\n            return err\n        }\n    }\n    return nil\n}\n\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"SubscriptionWorkflow()")," function requires two arguments: ",(0,o.kt)("inlineCode",{parentName:"p"},"ctx")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"EmailDetails"),".  ",(0,o.kt)("inlineCode",{parentName:"p"},"ctx")," references ",(0,o.kt)("inlineCode",{parentName:"p"},"workflow.Context"),", which the Go SDK uses to pass around Workflow Execution context.\n",(0,o.kt)("inlineCode",{parentName:"p"},"EmailDetails")," propagates the function's ",(0,o.kt)("inlineCode",{parentName:"p"},"data")," struct. which will be used to execute the Activity."),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"SubscriptionWorkflow()")," function uses a ",(0,o.kt)("inlineCode",{parentName:"p"},"for")," loop to send the emails. The ",(0,o.kt)("inlineCode",{parentName:"p"},"for")," loop executes the ",(0,o.kt)("inlineCode",{parentName:"p"},"SendEmail")," Activity while ",(0,o.kt)("inlineCode",{parentName:"p"},"IsSubscribed")," is ",(0,o.kt)("inlineCode",{parentName:"p"},"true"),", and uses a Timer to pause the Workflow between emails.  The Timer can pause the Workflow for seconds, days, months, or even years, depending on your business logic."),(0,o.kt)("p",null,"Later in this tutorial, you will find that the user's email address is set to the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.temporal.io/workflows#workflow-id"},"Workflow Id"),". This means that attempting to subscribe with the same email address twice will result in an error and prevent the Workflow Execution from spawning again."),(0,o.kt)("p",null,"Therefore, only one running Workflow Execution per email address can exist within the associated ",(0,o.kt)("a",{parentName:"p",href:"https://docs.temporal.io/namespaces"},"Namespace"),".\nThis ensures that the user won't receive multiple email subscriptions. This also helps reduce the complexity of the code you have to write and maintain."),(0,o.kt)("p",null,"With this Workflow Definition in place, you can now develop an Activity to send emails."),(0,o.kt)("h2",{id:"develop-the-activities"},"Develop the Activities"),(0,o.kt)("p",null,"An ",(0,o.kt)("a",{parentName:"p",href:"https://docs.temporal.io/activities"},"Activity")," is a normal function or method that executes a single, well-defined action (either short or long running), such as calling another service, transcoding a media file, or sending an email message. Workflow code orchestrates the execution of Activities, persisting the results."),(0,o.kt)("p",null,"Create a new file called ",(0,o.kt)("inlineCode",{parentName:"p"},"activities.go")," and add the following code to create the Activity Definition:"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-go/blob/main/activities.go"},"activities.go")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'package subscribeemails\n\nimport (\n    "context"\n\n    "go.temporal.io/sdk/activity"\n)\n\n// email activities\nfunc SendEmail(ctx context.Context, emailInfo EmailDetails) (string, error) {\n    activity.GetLogger(ctx).Info("Sending email to customer", "EmailAddress", emailInfo.EmailAddress)\n    return "Email sent to " + emailInfo.EmailAddress, nil\n}\n\n')),(0,o.kt)("p",null,"Each iteration of the Workflow loop will execute this Activity, which simulates sending a message to the user."),(0,o.kt)("p",null,"Now that the Activity Definition and Workflow Definition have been created, it's time to write the Worker process."),(0,o.kt)("h2",{id:"build-the-worker"},"Build the Worker"),(0,o.kt)("p",null,"Temporal Workflows and Activities are executed by ",(0,o.kt)("a",{parentName:"p",href:"https://docs.temporal.io/workers"},"Workers")," that listen on specific Task Queues. When Workflows and Activities return, the Workers send the results back to the Temporal Cluster."),(0,o.kt)("p",null,"Create a ",(0,o.kt)("inlineCode",{parentName:"p"},"worker")," folder, and create the ",(0,o.kt)("inlineCode",{parentName:"p"},"main.go")," file for the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.temporal.io/workers#worker-program"},"Worker program"),"."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-go/blob/main/worker/main.go"},"worker/main.go")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'package main\n\nimport (\n    "log"\n    "subscribeemails"\n\n    "go.temporal.io/sdk/client"\n    "go.temporal.io/sdk/worker"\n)\n\nfunc main() {\n    // create client and worker\n    c, err := client.Dial(client.Options {\n        HostPort: client.DefaultHostPort,\n        Namespace: client.DefaultNamespace,\n    })\n    if err != nil {\n        log.Fatalln("Unable to create Temporal Client.", err)\n    }\n    defer c.Close()\n    // create Worker\n    w := worker.New(c, subscribeemails.TaskQueueName, worker.Options{})\n    // register Activity and Workflow\n    w.RegisterWorkflow(subscribeemails.SubscriptionWorkflow)\n    w.RegisterActivity(subscribeemails.SendEmail)\n\n    log.Println("Worker is starting.")\n    // Listen to Task Queue\n    err = w.Run(worker.InterruptCh())\n    if err != nil {\n        log.Fatalln("Unable to start Worker.", err)\n    }\n}\n')),(0,o.kt)("p",null,"Now that you've written the logic to execute the Workflow and Activity Definitions, try to build the gateway."),(0,o.kt)("h2",{id:"build-the-web-server"},"Build the web server"),(0,o.kt)("p",null,"The web server is used to handle requests.\nThis tutorial uses ",(0,o.kt)("a",{parentName:"p",href:"https://pkg.go.dev/net/http"},"Go's HTTP library")," as the entry point for initiating Workflow Executions and for communicating with the ",(0,o.kt)("inlineCode",{parentName:"p"},"/subscribe"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"/unsubscribe"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"/details")," endpoints. "),(0,o.kt)("p",null,"Create a ",(0,o.kt)("inlineCode",{parentName:"p"},"gateway")," folder with the file ",(0,o.kt)("inlineCode",{parentName:"p"},"main.go"),".\nEstablish your JSON request and response structs, set the endpoint handlers, and connect to the Temporal Client."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-go/blob/main/gateway/main.go"},"gateway/main.go")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'package main\n\nimport (\n    "context"\n    "encoding/json"\n    "fmt"\n    "log"\n    "net/http"\n    "net/url"\n    "subscribeemails"\n\n    "go.temporal.io/sdk/client"\n)\n\nvar temporalClient client.Client\n\ntype RequestData struct {\n    Email string `json:"email"`\n}\n\ntype ResponseData struct {\n    Status  string `json:"status"`\n    Message string `json:"message"`\n}\n\n// ...\nfunc main() {\n\n    var err error\n    temporalClient, err = client.Dial(client.Options{\n        HostPort: client.DefaultHostPort,\n    })\n\n    if err != nil {\n        panic(err)\n    }\n\n    fmt.Printf("Starting the web server on %s\\n", subscribeemails.ClientHostPort)\n\n    http.HandleFunc("/subscribe", subscribeHandler)\n    http.HandleFunc("/unsubscribe", unsubscribeHandler)\n    http.HandleFunc("/details", showDetailsHandler)\n    _ = http.ListenAndServe(":4000", nil)\n}\n\n')),(0,o.kt)("p",null,"The Temporal Client enables you to communicate with the Temporal Cluster. Communication with a Temporal Cluster includes, but isn't limited to, the following:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Starting Workflow Executions"),(0,o.kt)("li",{parentName:"ul"},"Querying Workflow Executions"),(0,o.kt)("li",{parentName:"ul"},"Getting the results of a Workflow Execution")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"RequestData")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"ResponseData")," structs format information in JSON format.\nTemporal recommends JSON formatting for data that's handled by other programs\u2014a good practice to establish for a future of live service interactions."),(0,o.kt)("p",null,"Now that the connection to the Temporal Server is open, define your first endpoint."),(0,o.kt)("p",null,"Create a ",(0,o.kt)("inlineCode",{parentName:"p"},"subscribeHandler()")," function in the same file so users can subscribe to the emails."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-go/blob/main/gateway/main.go"},"gateway/main.go")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'// ...\n// create subscribe handler, which collects the email in the index handler form\nfunc subscribeHandler(w http.ResponseWriter, r *http.Request) {\n\n    // only respond to POST\n    if r.Method != http.MethodPost {\n        http.Error(w, "Method not allowed", http.StatusMethodNotAllowed)\n        return\n    }\n\n    // ensure JSON request\n    if r.Header.Get("Content-Type") != "application/json" {\n        http.Error(w, "Invalid Content-Type, expecting application/json", http.StatusUnsupportedMediaType)\n        return\n    }\n\n    var requestData RequestData\n\n    // decode request into variable\n    err := json.NewDecoder(r.Body).Decode(&requestData)\n    if err != nil {\n        http.Error(w, "Error processing request body", http.StatusBadRequest)\n        return\n    }\n\n    // check if the email is blank\n    if requestData.Email == "" {\n        http.Error(w, "Email is blank", http.StatusBadRequest)\n        return\n    }\n\n    // use the email as the id in the workflow.\n    workflowOptions := client.StartWorkflowOptions{\n        ID:                                       requestData.Email,\n        TaskQueue:                                subscribeemails.TaskQueueName,\n        WorkflowExecutionErrorWhenAlreadyStarted: true,\n    }\n\n    // Define the EmailDetails struct\n    subscription := subscribeemails.EmailDetails{\n        EmailAddress:      requestData.Email,\n        Message:           "Welcome to the Subscription Workflow!",\n        SubscriptionCount: 0,\n        IsSubscribed:      true,\n    }\n\n    // Execute the Temporal Workflow to start the subscription.\n    _, err = temporalClient.ExecuteWorkflow(context.Background(), workflowOptions, subscribeemails.SubscriptionWorkflow, subscription)\n\n    if err != nil {\n        http.Error(w, "Couldn\'t sign up user. Please try again.", http.StatusInternalServerError)\n        log.Print(err)\n        return\n    }\n\n    // build response\n    responseData := ResponseData{\n        Status:  "success",\n        Message: "Signed up.",\n    }\n\n    // send headers\n    w.Header().Set("Content-Type", "application/json")\n    w.WriteHeader(http.StatusCreated) // 201 Created status code\n\n    // send response\n    if err := json.NewEncoder(w).Encode(responseData); err != nil {\n        log.Print("Could not encode response JSON", err)\n        http.Error(w, "Internal server error", http.StatusInternalServerError)\n    }\n}\n\n')),(0,o.kt)("p",null,'Use error handlers to ensure that the function only responds to a "POST" request in JSON format.\nAfter decoding the request, use ',(0,o.kt)("inlineCode",{parentName:"p"},"workflowOptions")," to pass in the user's email address and set the Workflow Id.\nThis ensures that the email is unique across all Workflows so that the user can't sign up multiple times.\nThey'll only receive the emails they've subscribed to, and once they unsubscribe, they cancel the Workflow run."),(0,o.kt)("p",null,'With this endpoint in place, you can now send a "POST" request to ',(0,o.kt)("inlineCode",{parentName:"p"},"/subscribe")," with an email address in the request body.\nIn return, you'll receive a JSON response that shows a new Workflow has started, along with a welcome email."),(0,o.kt)("p",null,"But how would you get details about the subscription?\nIn the next section, you'll query your Workflow to get back information on the state of things."),(0,o.kt)("h2",{id:"add-a-query"},"Add a Query"),(0,o.kt)("p",null,"You can let users get information about their subscription details by using a Query."),(0,o.kt)("p",null,"To allow users to retrieve information about their subscription details, add a new Query handler to the ",(0,o.kt)("inlineCode",{parentName:"p"},"SendEmailWorkflow")," Workflow."),(0,o.kt)("p",null,"Open the ",(0,o.kt)("inlineCode",{parentName:"p"},"workflow.go")," file and add a Query handler to the top of the Workflow Definition, right after the logging statement::"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-go/blob/main/workflow.go"},"workflow.go")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'// ...\n\n    // Query handler\n    err := workflow.SetQueryHandler(ctx, "GetDetails", func() (EmailDetails, error) {\n        return emailDetails, nil\n    })\n\n    if err != nil {\n        return err\n    }\n    // variable for Activity Options. Timeout can be set to a longer timespan (such as a month)\n')),(0,o.kt)("p",null,"This Query handler returns the contents of the ",(0,o.kt)("inlineCode",{parentName:"p"},"emailDetails")," variable. Queries should never mutate anything in the Workflow."),(0,o.kt)("p",null,"You can use Queries even if the Workflow completes, which is useful for when the user unsubscribes but still wants to retrieve information about their subscription."),(0,o.kt)("p",null,"Now that you've added the ability to Query your Workflow, add the ability to Query from the web API. "),(0,o.kt)("p",null,"Create a function called ",(0,o.kt)("inlineCode",{parentName:"p"},"showDetailsHandler()"),' in which a user can get information about their subscription details.\nMake sure to include error handlers to ensure proper "GET" requests and responses.'),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-go/blob/main/gateway/main.go"},"gateway/main.go")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'// ...\n// create part of the Query handler that returns information at localhost:4000/details\nfunc showDetailsHandler(w http.ResponseWriter, r *http.Request) {\n    // Parse the query string\n    queryValues, err := url.ParseQuery(r.URL.RawQuery)\n    if err != nil {\n        http.Error(w, "Couldn\'t query values. Please try again.", http.StatusInternalServerError)\n        log.Println("Failed to query Workflow.")\n        return\n    }\n\n    // Extract the email parameter\n    email := queryValues.Get("email")\n\n    workflowID := email\n    queryType := "GetDetails"\n\n    // print email, billing period, charge, etc.\n    resp, err := temporalClient.QueryWorkflow(context.Background(), workflowID, "", queryType)\n    if err != nil {\n        http.Error(w, "Couldn\'t query values. Please try again.", http.StatusInternalServerError)\n        log.Println("Failed to query Workflow.")\n        return\n    }\n\n    var result subscribeemails.EmailDetails\n\n    if err := resp.Get(&result); err != nil {\n        http.Error(w, "Couldn\'t query values. Please try again.", http.StatusInternalServerError)\n        log.Println("Failed to query Workflow.")\n        return\n    }\n\n    // send headers\n    w.Header().Set("Content-Type", "application/json")\n    w.WriteHeader(http.StatusCreated) // 201 Created status code\n\n    // send response\n    if err := json.NewEncoder(w).Encode(result); err != nil {\n        log.Print("Could not encode response JSON", err)\n        http.Error(w, "Internal server error", http.StatusInternalServerError)\n    }\n}\n\n')),(0,o.kt)("p",null,"The resulting function returns the email address associated with the Workflow\u2014in other words, the Workflow Id."),(0,o.kt)("p",null,"Now that users can subscribe and view the details of their subscription, you need to provide them with a way to unsubscribe."),(0,o.kt)("h2",{id:"unsubscribe-users-with-a-workflow-cancellation-request"},"Unsubscribe users with a Workflow Cancellation request"),(0,o.kt)("p",null,"Users will need to unsubscribe from the email list at some point. To gracefully handle the Unsubscribe request, the Workflow Definition needs a cancellation handler."),(0,o.kt)("p",null,"Create a new ",(0,o.kt)("inlineCode",{parentName:"p"},"defer")," block within ",(0,o.kt)("inlineCode",{parentName:"p"},"SubscriptionWorkflow()")," to send cancellation emails and end the Workflow Execution:"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-go/blob/main/workflow.go"},"workflow.go")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'// ...\n    defer func() {\n        newCtx, cancel := workflow.NewDisconnectedContext(ctx)\n        defer cancel()\n\n        if errors.Is(ctx.Err(), workflow.ErrCanceled) {\n            data := EmailDetails{\n                EmailAddress:      emailDetails.EmailAddress,\n                Message:           "Your subscription has been canceled. Sorry to see you go!",\n                IsSubscribed:      false,\n                SubscriptionCount: emailDetails.SubscriptionCount,\n            }\n            // send cancellation email\n            err := workflow.ExecuteActivity(newCtx, SendEmail, data).Get(newCtx, nil)\n            if err != nil {\n                logger.Error("Failed to send cancellation email", "Error", err)\n            } else {\n                // Cancellation received.\n                logger.Info("Sent cancellation email", "EmailAddress", emailDetails.EmailAddress)\n            }\n        }\n    }()\n\n')),(0,o.kt)("p",null,"To send a cancellation notice to an endpoint, use the HTTP ",(0,o.kt)("inlineCode",{parentName:"p"},"DELETE")," method on the ",(0,o.kt)("inlineCode",{parentName:"p"},"unsubscribe")," endpoint to return a ",(0,o.kt)("a",{parentName:"p",href:"https://python.temporal.io/temporalio.client.WorkflowHandle.html#cancel"},"cancel()")," method on the Workflow's handle."),(0,o.kt)("p",null,"Create a new function called ",(0,o.kt)("inlineCode",{parentName:"p"},"unsubscribeHandler()")," that sends a cancellation request to the Workflow Execution."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-go/blob/main/gateway/main.go"},"gateway/main.go")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'// ...\n// create unsubscribe handler, accessed at localhost:4000/unsubscribe\nfunc unsubscribeHandler(w http.ResponseWriter, r *http.Request) {\n\n    // only respond to POST\n    if r.Method != http.MethodDelete {\n        http.Error(w, "Method not allowed", http.StatusMethodNotAllowed)\n        return\n    }\n\n    // ensure JSON request\n    if r.Header.Get("Content-Type") != "application/json" {\n        http.Error(w, "Invalid Content-Type, expecting application/json", http.StatusUnsupportedMediaType)\n        return\n    }\n\n    var requestData RequestData\n\n    // decode request into variable\n    err := json.NewDecoder(r.Body).Decode(&requestData)\n    if err != nil {\n        http.Error(w, "Error processing request body", http.StatusBadRequest)\n        return\n    }\n\n    // check if the email is blank\n    if requestData.Email == "" {\n        http.Error(w, "Email is blank", http.StatusBadRequest)\n        return\n    }\n    workflowID := requestData.Email\n\n    // cancel the Workflow Execution\n    err = temporalClient.CancelWorkflow(context.Background(), workflowID, "")\n    if err != nil {\n        http.Error(w, "Couldn\'t unsubscribe. Please try again.", http.StatusInternalServerError)\n        log.Print(err)\n        return\n    }\n\n    // build response\n    responseData := ResponseData{\n        Status:  "success",\n        Message: "Unsubscribed.",\n    }\n\n    // send headers\n    w.Header().Set("Content-Type", "application/json")\n    w.WriteHeader(http.StatusAccepted) // 202 Accepted status code\n\n    // send response\n    if err := json.NewEncoder(w).Encode(responseData); err != nil {\n        log.Print("Could not encode response JSON", err)\n        http.Error(w, "Internal server error", http.StatusInternalServerError)\n    }\n}\n\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"CancelWorkflow()")," function sends a cancellation request to the Workflow Execution you started on the ",(0,o.kt)("inlineCode",{parentName:"p"},"/subscribe")," endpoint. "),(0,o.kt)("p",null,"When the Workflow receives the cancellation request, it will cancel the Workflow Execution and return a ",(0,o.kt)("inlineCode",{parentName:"p"},"CancelledError")," to the Workflow Execution.\nThis is then handled by the error handlers included in the ",(0,o.kt)("inlineCode",{parentName:"p"},"unsubscribeHandler()")," function."),(0,o.kt)("p",null,'Users can now send a "DELETE" request to ',(0,o.kt)("inlineCode",{parentName:"p"},"/unsubscribe")," to cancel the Workflow associated with the request body's email address.\nThis lets users unsubscribe from the email list and prevent any further emails from sending."),(0,o.kt)("p",null,"Now that you've added the ability to unsubscribe from the email list, test your application code to ensure it works as expected."),(0,o.kt)("h2",{id:"create-integration-tests"},"Create integration tests"),(0,o.kt)("p",null,"Integration testing is an essential part of software development that helps ensure that different components of an application work together correctly.\nIn this section, you'll write an integration test using the Go SDK to test the cancellation of a Workflow."),(0,o.kt)("p",null,"The Temporal Go SDK includes functions to help test your Workflow Executions.\nUse these functions alongside the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/stretchr/testify"},"Testify module")," to create integration tests against a test server or a given Client."),(0,o.kt)("p",null,"To set up the test environment, create a new file called ",(0,o.kt)("inlineCode",{parentName:"p"},"subscription_test.go"),".\nCreate a test function called ",(0,o.kt)("inlineCode",{parentName:"p"},"Test_CanceledSubscriptionWorkflow()"),"."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-go/blob/main/subscription_test.go"},"subscription_test.go")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'package subscribeemails\n\nimport (\n    "testing"\n    "time"\n\n    "go.temporal.io/sdk/testsuite"\n)\n\nfunc Test_CanceledSubscriptionWorkflow(t *testing.T) {\n    testSuite := &testsuite.WorkflowTestSuite{}\n    env := testSuite.NewTestWorkflowEnvironment()\n\n    testDetails := EmailDetails{\n        EmailAddress:      "example@temporal.io",\n        Message:           "This is a test to see if the Workflow cancels. This is dependent on the bool variable in the testDetails struct.",\n        IsSubscribed:      true,\n        SubscriptionCount: 12,\n    }\n\n    // set delayed callback to allow time for cancellation.\n    env.RegisterDelayedCallback(func() {\n        env.CancelWorkflow()\n    }, 5 * time.Second)\n\n    env.RegisterWorkflow(SubscriptionWorkflow)\n    env.RegisterActivity(SendEmail)\n\n    env.ExecuteWorkflow(SubscriptionWorkflow, testDetails)\n}\n\n\n\n\n')),(0,o.kt)("p",null,"This function creates a Workflow Execution by starting the Workflow with some test data.\nThe function then cancels it with the ",(0,o.kt)("inlineCode",{parentName:"p"},"CancelWorkflow()")," function that was assigned to ",(0,o.kt)("inlineCode",{parentName:"p"},"RegisterDelayedCallback()"),"."),(0,o.kt)("p",null,"With the test function created, run it to see if it works.\nUse the command ",(0,o.kt)("inlineCode",{parentName:"p"},"go test")," to start the test."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"subscription-workflow-go % go test\n2023/08/21 11:43:40 INFO  Subscription created EmailAddress example@temporal.io\n2023/08/21 11:43:40 INFO  Sending welcome email EmailAddress example@temporal.io\n2023/08/21 11:43:40 INFO  Sending email to customer ActivityID 2 ActivityType SendEmail Attempt 1 WorkflowType SubscriptionWorkflow WorkflowID default-test-workflow-id RunID default-test-run-id EmailAddress example@temporal.io\n2023/08/21 11:43:40 DEBUG handleActivityResult: *workflowservice.RespondActivityTaskCompletedRequest. ActivityID 2 ActivityType SendEmail\n2023/08/21 11:43:40 INFO  Sending email to customer ActivityID 3 ActivityType SendEmail Attempt 1 WorkflowType SubscriptionWorkflow WorkflowID default-test-workflow-id RunID default-test-run-id EmailAddress example@temporal.io\n2023/08/21 11:43:40 DEBUG handleActivityResult: *workflowservice.RespondActivityTaskCompletedRequest. ActivityID 3 ActivityType SendEmail\n2023/08/21 11:43:40 INFO  Sent content email EmailAddress example@temporal.io\n2023/08/21 11:43:40 DEBUG Auto fire timer TimerID 0 TimerDuration 5s TimeSkipped 5s\n2023/08/21 11:43:40 DEBUG RequestCancelTimer TimerID 4\n2023/08/21 11:43:40 INFO  Sending email to customer ActivityID 5 ActivityType SendEmail Attempt 1 WorkflowType SubscriptionWorkflow WorkflowID default-test-workflow-id RunID default-test-run-id EmailAddress example@temporal.io\n2023/08/21 11:43:40 DEBUG handleActivityResult: *workflowservice.RespondActivityTaskCompletedRequest. ActivityID 5 ActivityType SendEmail\n2023/08/21 11:43:40 INFO  Sent cancellation email EmailAddress example@temporal.io\nPASS\nok      subscribeemails 0.285s\n")),(0,o.kt)("p",null,"With a cancellation request that fires after five seconds, this test shows the successful creation of a subscription as well as its cancellation.\nYou've successfully written, executed, and passed a Cancellation Workflow test. "),(0,o.kt)("p",null,"Temporal's Go SDK provides a number of functions that help you test your Workflow Executions.\nBy following the best practices for testing your code, you can be confident that your Workflows are reliable and performant."),(0,o.kt)("h2",{id:"conclusion"},"Conclusion"),(0,o.kt)("p",null,"This tutorial demonstrates how to build an email subscription application using Temporal and Go.\nBy leveraging Workflows, Activities, and Queries, the tutorial shows how to create a web server that interacts with Temporal to manage the subscription process."),(0,o.kt)("p",null,"With this knowledge, you'll be able to use more complex Workflows and Activities to create even stronger applications."))}p.isMDXComponent=!0}}]);