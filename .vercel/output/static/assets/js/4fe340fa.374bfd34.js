"use strict";(self.webpackChunktemporal_learning=self.webpackChunktemporal_learning||[]).push([[717],{5997:(e,t,n)=>{n.d(t,{Zt:()=>o,yT:()=>l});var i=n(7294),a=n(2004);const l=function(e){let{url:t,loop:n,playing:l}=e;return i.createElement("div",{className:"relative rounded-lg shadow-lg",style:{position:"relative",paddingTop:"56.25%",marginBottom:20}},i.createElement(a.Z,{url:t,loop:n,playing:l,width:"100%",height:"100%",controls:!0,style:{position:"absolute",top:0,left:0}}))};n(4673);var r=n(3612);function o(){return i.createElement(r.Z,{type:"info",title:"WORK IN PROGRESS"},i.createElement("p",null,"This tutorial is a work in progress. Some sections may be incomplete, out of date, or missing. We're working to update it."))}},7414:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>c,default:()=>h,frontMatter:()=>s,metadata:()=>u,toc:()=>d});var i=n(3117),a=(n(7294),n(3905)),l=n(5162),r=n(4866),o=n(5997);const s={id:"subscription-tutorial",sidebar_position:3,keywords:["TypeScript","temporal","sdk","tutorial"],tags:["TypeScript","SDK"],last_update:{date:new Date("2021-10-01T00:00:00.000Z")},title:"Build a subscription workflow with Temporal and TypeScript",description:"In this tutorial, we will tour all of the Workflow APIs you should know, primarily Signals, Queries, `condition`, and `sleep`, by building a realistic monthly subscription payments workflow that can be canceled and changed while it runs.",image:"/img/temporal-logo-twitter-card.png"},c=void 0,u={unversionedId:"tutorials/typescript/subscriptions/subscription-tutorial",id:"tutorials/typescript/subscriptions/subscription-tutorial",title:"Build a subscription workflow with Temporal and TypeScript",description:"In this tutorial, we will tour all of the Workflow APIs you should know, primarily Signals, Queries, `condition`, and `sleep`, by building a realistic monthly subscription payments workflow that can be canceled and changed while it runs.",source:"@site/docs/tutorials/typescript/subscriptions/index.md",sourceDirName:"tutorials/typescript/subscriptions",slug:"/tutorials/typescript/subscriptions/",permalink:"/tutorials/typescript/subscriptions/",draft:!1,tags:[{label:"TypeScript",permalink:"/tags/type-script"},{label:"SDK",permalink:"/tags/sdk"}],version:"current",lastUpdatedAt:1633046400,formattedLastUpdatedAt:"Oct 1, 2021",sidebarPosition:3,frontMatter:{id:"subscription-tutorial",sidebar_position:3,keywords:["TypeScript","temporal","sdk","tutorial"],tags:["TypeScript","SDK"],last_update:{date:"2021-10-01T00:00:00.000Z"},title:"Build a subscription workflow with Temporal and TypeScript",description:"In this tutorial, we will tour all of the Workflow APIs you should know, primarily Signals, Queries, `condition`, and `sleep`, by building a realistic monthly subscription payments workflow that can be canceled and changed while it runs.",image:"/img/temporal-logo-twitter-card.png"},sidebar:"tutorialSidebar",previous:{title:"Integrating Temporal into an existing Next.js application",permalink:"/tutorials/typescript/nextjs/"},next:{title:"Choose Your Own Adventure Bot walkthrough in TypeScript",permalink:"/tutorials/typescript/chatbot/"}},p={},d=[{value:"Introduction",id:"introduction",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Create the project",id:"create-the-project",level:2},{value:"Write the Activities",id:"write-the-activities",level:2},{value:"Write a simple Free Trial Workflow with <code>sleep</code>",id:"write-a-simple-free-trial-workflow-with-sleep",level:2},{value:"Receive Cancellations with a Signal",id:"receive-cancellations-with-a-signal",level:2},{value:"Inside the Workflow",id:"inside-the-workflow",level:3},{value:"Invoke from the Client",id:"invoke-from-the-client",level:3},{value:"Using <code>condition</code> with timeouts",id:"using-condition-with-timeouts",level:2},{value:"Data Model",id:"data-model",level:2},{value:"Write the Billing Process",id:"write-the-billing-process",level:2},{value:"Queries and Reusable Functions",id:"queries-and-reusable-functions",level:2},{value:"End Result",id:"end-result",level:2},{value:"Next Steps",id:"next-steps",level:2}],m={toc:d};function h(e){let{components:t,...s}=e;return(0,a.kt)("wrapper",(0,i.Z)({},m,s,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Temporal TypeScript SDK",src:n(2813).Z,width:"902",height:"254"})),(0,a.kt)(o.Zt,{mdxType:"OutdatedNotice"}),(0,a.kt)("h2",{id:"introduction"},"Introduction"),(0,a.kt)("p",null,"In this tutorial, you will tour all of the ",(0,a.kt)("a",{parentName:"p",href:"https://docs.temporal.io/typescript/workflows#workflow-apis"},"Workflow APIs")," you should know, primarily Signals, Queries, ",(0,a.kt)("inlineCode",{parentName:"p"},"condition"),", and ",(0,a.kt)("inlineCode",{parentName:"p"},"sleep")," (and eventually Child Workflows and ",(0,a.kt)("inlineCode",{parentName:"p"},"continueAsNew"),"), by building a realistic monthly subscription payments workflow that can be canceled and changed while it runs."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"The goal is to give you a more accessible introduction to these APIs by explaining them in context of a realistic application."),(0,a.kt)("li",{parentName:"ul"},"We also give an example of how you break down project requirements into Activities and Workflow logic.")),(0,a.kt)("p",null,"Your task is to write a Workflow for a limited time Subscription (eg a 36 month Phone plan) that satisfies these conditions:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"When the user signs up, ",(0,a.kt)("strong",{parentName:"li"},"send a welcome email")," and start a free trial for ",(0,a.kt)("inlineCode",{parentName:"li"},"TrialPeriod"),"."),(0,a.kt)("li",{parentName:"ol"},"When the ",(0,a.kt)("inlineCode",{parentName:"li"},"TrialPeriod")," expires, start the billing process",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"If the user cancels during the trial, ",(0,a.kt)("strong",{parentName:"li"},"send a trial cancellation email"),"."))),(0,a.kt)("li",{parentName:"ol"},"Billing Process:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"As long as you have not exceeded ",(0,a.kt)("inlineCode",{parentName:"li"},"MaxBillingPeriods"),","),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Charge the customer")," for the ",(0,a.kt)("inlineCode",{parentName:"li"},"BillingPeriodChargeAmount"),"."),(0,a.kt)("li",{parentName:"ul"},"Then wait for the next ",(0,a.kt)("inlineCode",{parentName:"li"},"BillingPeriod"),"."),(0,a.kt)("li",{parentName:"ul"},"If the customer cancels during a billing period, ",(0,a.kt)("strong",{parentName:"li"},"send a subscription cancellation email"),"."),(0,a.kt)("li",{parentName:"ul"},"If Subscription has ended normally (exceeded ",(0,a.kt)("inlineCode",{parentName:"li"},"MaxBillingPeriods")," without cancellation), ",(0,a.kt)("strong",{parentName:"li"},"send a subscription ended email"),"."))),(0,a.kt)("li",{parentName:"ol"},"At any point while subscriptions are ongoing, be able to look up and change any customer's:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Amount Charged"),(0,a.kt)("li",{parentName:"ul"},"Period number (for manual adjustments e.g. refunds)")))),(0,a.kt)("p",null,"Of course, this all has to be fault tolerant, scalable to millions of customers, testable, maintainable, and observable."),(0,a.kt)("admonition",{title:"Skip ahead",type:"tip"},(0,a.kt)("p",{parentName:"admonition"},(0,a.kt)("strong",{parentName:"p"},"To skip straight to a fully working example, you can check our ",(0,a.kt)("a",{parentName:"strong",href:"https://github.com/temporalio/subscription-workflow-project-template-typescript"},"Subscription Workflow repo"))," (it is slightly different from the code explained below, as this tutorial has been edited for readability and assumes you are comfortable with Node.js so the difference is immaterial).")),(0,a.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"/getting_started/typescript/dev_environment/"},"Set up a local development environment for developing Temporal applications using TypeScript")),(0,a.kt)("li",{parentName:"ul"},"Review the ",(0,a.kt)("a",{parentName:"li",href:"/getting_started/typescript/hello_world_in_typescript/"},"Hello World in TypeScript tutorial")," to understand the basics of getting a Temporal TypeScript SDK project up and running.")),(0,a.kt)("p",null,"We don't assume knowledge of the Workflow APIs, but we do expect that you are reasonably comfortable with TypeScript/Node.js."),(0,a.kt)("h2",{id:"create-the-project"},"Create the project"),(0,a.kt)("p",null,"We'll start out this project with the Hello World example, which you can always scaffold out with our Package Initializer:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-command"},"npx @temporalio/create@latest subscription-tutorial --sample hello-world\n")),(0,a.kt)("h2",{id:"write-the-activities"},"Write the Activities"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Each of the bolded items in our requirements are actions involving the outside world")," (charging customers, sending emails), so they should be written as ",(0,a.kt)("a",{parentName:"p",href:"https://docs.temporal.io/dev-guide/typescript/foundations/#develop-activities"},"Activities"),"."),(0,a.kt)("p",null,"Activities are not the focus of this tutorial so they are elided, but you may wish to write them first as they are self contained pieces of regular Node.js code, and you may discover more data model requirements in this process that impact how you write Workflows."),(0,a.kt)("p",null,"For now, we'll simply stub them out with ",(0,a.kt)("inlineCode",{parentName:"p"},"console.log"),"."),(0,a.kt)("h2",{id:"write-a-simple-free-trial-workflow-with-sleep"},"Write a simple Free Trial Workflow with ",(0,a.kt)("inlineCode",{parentName:"h2"},"sleep")),(0,a.kt)("p",null,"A nice first subset of the requirements is to send the email, wait for the trial period, and then send the subscription ended email:"),(0,a.kt)(r.Z,{groupId:"language",defaultValue:"ts",values:[{label:"TypeScript",value:"ts"},{label:"JavaScript",value:"js"}],mdxType:"Tabs"},(0,a.kt)(l.Z,{value:"ts",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"// /src/workflows.ts\nimport { sleep, proxyActivities } from '@temporalio/workflow';\nimport type * as activities from './activities';\n\nconst { sendWelcomeEmail, sendSubscriptionOverEmail } = proxyActivities<\n  typeof activities\n>({\n  startToCloseTimeout: '1 minute',\n});\n\nexport async function SubscriptionWorkflow(\n  email: string,\n  trialPeriod: string | number\n) {\n  await sendWelcomeEmail(email);\n  await sleep(trialPeriod);\n  await sendSubscriptionOverEmail(email);\n}\n"))),(0,a.kt)(l.Z,{value:"js",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"// /src/workflows.ts\nimport { sleep, proxyActivities } from '@temporalio/workflow';\n\nconst { sendWelcomeEmail, sendSubscriptionOverEmail } = proxyActivities({\n  startToCloseTimeout: '1 minute',\n});\n\nexport async function SubscriptionWorkflow(email, trialPeriod) {\n  await sendWelcomeEmail(email);\n  await sleep(trialPeriod);\n  await sendSubscriptionOverEmail(email);\n}\n")))),(0,a.kt)("p",null,"Here we are using the ",(0,a.kt)("inlineCode",{parentName:"p"},"sleep")," API for the first time.\nIt does what it says; defers execution for a preset time (note that it accepts both a string or number of milliseconds, ",(0,a.kt)("a",{parentName:"p",href:"https://docs.temporal.io/typescript/workflows#sleep"},"per its docs"),")."),(0,a.kt)("p",null,"To test this out, you will also have to modify your Client code accordingly:"),(0,a.kt)(r.Z,{groupId:"language",defaultValue:"ts",values:[{label:"TypeScript",value:"ts"},{label:"JavaScript",value:"js"}],mdxType:"Tabs"},(0,a.kt)(l.Z,{value:"ts",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"// /src/client.ts\nimport { SubscriptionWorkflow } from './workflows';\n\n// etc...\nconst result = await client.execute(SubscriptionWorkflow, {\n  workflowId: 'business-meaningful-id',\n  taskQueue: 'tutorial',\n  args: ['foo@bar.com', '30 seconds'],\n});\n"))),(0,a.kt)(l.Z,{value:"js",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"// /src/client.ts\nimport { SubscriptionWorkflow } from './workflows';\n\n// etc...\nconst result = await client.execute(SubscriptionWorkflow, {\n  workflowId: 'business-meaningful-id',\n  taskQueue: 'tutorial',\n  args: ['foo@bar.com', '30 seconds'],\n});\n")))),(0,a.kt)("p",null,"Notice that the ",(0,a.kt)("inlineCode",{parentName:"p"},"args")," are typechecked against the signature of ",(0,a.kt)("inlineCode",{parentName:"p"},"SubscriptionWorkflow"),".\nWe also take the opportunity to specify the ",(0,a.kt)("inlineCode",{parentName:"p"},"workflowId"),", which we recommend in production."),(0,a.kt)("p",null,"Check that you can run the Workflow (",(0,a.kt)("inlineCode",{parentName:"p"},"npm run workflow"),') and everything works as expected (if it is still printing "Hello Temporal", make sure you restart your Workers to pick up changes in your code, which you can automate with ',(0,a.kt)("inlineCode",{parentName:"p"},"npm run start.watch"),")."),(0,a.kt)("p",null,"From here on we expect that you are comfortable with making changes to Workflows and rerunning them to verify that they work as expected after each change."),(0,a.kt)("admonition",{title:"The importance of deferred execution",type:"note"},(0,a.kt)("p",{parentName:"admonition"},(0,a.kt)("inlineCode",{parentName:"p"},"sleep")," is a simple, but powerful ",(0,a.kt)("strong",{parentName:"p"},"durable timer"),"; under the hood, Temporal Server is persisting the sleep details to the database to be picked up later by the internal scheduler.\nTest the fault tolerance of this by intentionally bringing down your Worker, or Temporal Server, during the ",(0,a.kt)("inlineCode",{parentName:"p"},"sleep"),", and notice that it simply continues when the system is back up again.")),(0,a.kt)("h2",{id:"receive-cancellations-with-a-signal"},"Receive Cancellations with a Signal"),(0,a.kt)("p",null,'Per Requirement 2, users can cancel during the trial.\nThe main way to send data in to a running Workflow is by "signalling" them.'),(0,a.kt)("p",null,"There are two steps to implementing a Signal:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Handle inside the Workflow"),(0,a.kt)("li",{parentName:"ul"},"Invoke from the Client")),(0,a.kt)("h3",{id:"inside-the-workflow"},"Inside the Workflow"),(0,a.kt)("p",null,"First we have to define the Signal, then set a handler for it.\nThe import code is starting to get a little verbose, so there are some optional couple of quality-of-life refactors you can do as well:"),(0,a.kt)(r.Z,{groupId:"language",defaultValue:"ts",values:[{label:"TypeScript",value:"ts"},{label:"JavaScript",value:"js"}],mdxType:"Tabs"},(0,a.kt)(l.Z,{value:"ts",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"// /src/workflows.ts\nimport * as wf from '@temporalio/workflow'; // don't need to import everything\n// import activity types\n\nconst acts = wf.proxyActivities<typeof activities>({\n  // don't need to destructure activities\n  startToCloseTimeout: '1 minute',\n});\n\nexport const cancelSubscription = wf.defineSignal('cancelSignal'); // new\n\nexport async function SubscriptionWorkflow(\n  email: string,\n  trialPeriod: string | number\n) {\n  let isCanceled = false; // internal variable to track cancel state\n  wf.setHandler(cancelSubscription, () => void (isCanceled = true)); // new\n  await acts.sendWelcomeEmail(email);\n  await wf.sleep(trialPeriod);\n  if (isCanceled) {\n    await acts.sendCancellationEmailDuringTrialPeriod(email); // new\n  } else {\n    await acts.sendSubscriptionOverEmail(email);\n  }\n}\n"))),(0,a.kt)(l.Z,{value:"js",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"// /src/workflows.ts\nimport * as wf from '@temporalio/workflow'; // don't need to import everything\n// import activity types\n\nconst acts = wf.proxyActivities({\n  // don't need to destructure activities\n  startToCloseTimeout: '1 minute',\n});\n\nexport const cancelSubscription = wf.defineSignal('cancelSignal'); // new\n\nexport async function SubscriptionWorkflow(email, trialPeriod) {\n  let isCanceled = false; // internal variable to track cancel state\n  wf.setHandler(cancelSubscription, () => void (isCanceled = true)); // new\n  await acts.sendWelcomeEmail(email);\n  await wf.sleep(trialPeriod);\n  if (isCanceled) {\n    await acts.sendCancellationEmailDuringTrialPeriod(email); // new\n  }\n  else {\n    await acts.sendSubscriptionOverEmail(email);\n  }\n}\n")))),(0,a.kt)("h3",{id:"invoke-from-the-client"},"Invoke from the Client"),(0,a.kt)("p",null,"To test your new Signal, you will need to write a new script that has a Client.\nCopy over most of the code from your original starter to ",(0,a.kt)("inlineCode",{parentName:"p"},"cancel-subscription.ts"),"."),(0,a.kt)("p",null,"To invoke the Signal from here, we have to get a handle to the running Workflow Execution, and then ",(0,a.kt)("inlineCode",{parentName:"p"},"signal")," it:"),(0,a.kt)(r.Z,{groupId:"language",defaultValue:"ts",values:[{label:"TypeScript",value:"ts"},{label:"JavaScript",value:"js"}],mdxType:"Tabs"},(0,a.kt)(l.Z,{value:"ts",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"// cancel-subscription.ts\nimport { cancelSubscription } from '../workflows';\n// ...\n\nconst handle = client.getHandle('business-meaningful-id'); // match the Workflow id\nawait handle.signal(cancelSubscription);\n"))),(0,a.kt)(l.Z,{value:"js",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"// cancel-subscription.ts\nimport { cancelSubscription } from '../workflows';\n// ...\n\nconst handle = client.getHandle('business-meaningful-id'); // match the Workflow id\nawait handle.signal(cancelSubscription);\n")))),(0,a.kt)("p",null,"When you run this script while the main ",(0,a.kt)("inlineCode",{parentName:"p"},"client")," script is running, you should be able to see the Signal registered in the Event History when you pull up the Workflow on Temporal Web."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"More importantly, there is a small bug with this code - the cancelation doesn't happen immediately when you cancel!")),(0,a.kt)("h2",{id:"using-condition-with-timeouts"},"Using ",(0,a.kt)("inlineCode",{parentName:"h2"},"condition")," with timeouts"),(0,a.kt)("p",null,"Where ",(0,a.kt)("inlineCode",{parentName:"p"},"sleep(ms)")," defers execution for a fixed time, ",(0,a.kt)("inlineCode",{parentName:"p"},"condition")," defers execution for an indefinite time until a given predicate function returns ",(0,a.kt)("inlineCode",{parentName:"p"},"true")," (",(0,a.kt)("a",{parentName:"p",href:"https://docs.temporal.io/typescript/workflows#condition"},"per the docs"),").\nSo a simple cancellation signal workflow could look like this:"),(0,a.kt)(r.Z,{groupId:"language",defaultValue:"ts",values:[{label:"TypeScript",value:"ts"},{label:"JavaScript",value:"js"}],mdxType:"Tabs"},(0,a.kt)(l.Z,{value:"ts",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"// not suggested code - just for illustrative purposes\nlet isCanceled = false;\nwf.setHandler(cancelSignal, () => void (isCanceled = true));\n\nawait acts.sendWelcomeEmail(email);\nawait wf.condition(() => isCanceled === true); // new! wait until isCanceled = true\nawait acts.sendCancellationEmailDuringTrialPeriod(email); // arrive here immediately after cancellation\n"))),(0,a.kt)(l.Z,{value:"js",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"// not suggested code - just for illustrative purposes\nlet isCanceled = false;\nwf.setHandler(cancelSignal, () => void (isCanceled = true));\n\nawait acts.sendWelcomeEmail(email);\nawait wf.condition(() => isCanceled === true); // new! wait until isCanceled = true\nawait acts.sendCancellationEmailDuringTrialPeriod(email); // arrive here immediately after cancellation\n")))),(0,a.kt)("p",null,"However, we need to ",(0,a.kt)("inlineCode",{parentName:"p"},"Promise.race")," this against the Trial Period to fulfil Requirement 2.\nThis is such a common need that we built it in as ",(0,a.kt)("inlineCode",{parentName:"p"},"condition"),"'s optional timeout argument:"),(0,a.kt)(r.Z,{groupId:"language",defaultValue:"ts",values:[{label:"TypeScript",value:"ts"},{label:"JavaScript",value:"js"}],mdxType:"Tabs"},(0,a.kt)(l.Z,{value:"ts",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"// /src/workflows.ts\n// ...\nexport async function SubscriptionWorkflow(\n  email: string,\n  trialPeriod: string | number\n) {\n  let isCanceled = false;\n  wf.setHandler(cancelSignal, () => void (isCanceled = true)); // new\n  await acts.sendWelcomeEmail(email);\n  if (await wf.condition(() => isCanceled, trialPeriod)) {\n    // reach here if predicate function is true\n    await acts.sendCancellationEmailDuringTrialPeriod(email);\n  } else {\n    // reach here if timeout happens first\n    await acts.sendSubscriptionOverEmail(email);\n  }\n}\n"))),(0,a.kt)(l.Z,{value:"js",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"// /src/workflows.ts\n// ...\nexport async function SubscriptionWorkflow(email, trialPeriod) {\n  let isCanceled = false;\n  wf.setHandler(cancelSignal, () => void (isCanceled = true)); // new\n  await acts.sendWelcomeEmail(email);\n  if (await wf.condition(() => isCanceled, trialPeriod)) {\n    // reach here if predicate function is true\n    await acts.sendCancellationEmailDuringTrialPeriod(email);\n  }\n  else {\n    // reach here if timeout happens first\n    await acts.sendSubscriptionOverEmail(email);\n  }\n}\n")))),(0,a.kt)("p",null,"Now when you run your ",(0,a.kt)("inlineCode",{parentName:"p"},"cancel-subscription")," script you can see that the cancellation happens immediately.\nAnd now you know the basics of writing asynchronous time- and Signal-based logic.\nWe have documented other patterns you are likely to use, like ",(0,a.kt)("a",{parentName:"p",href:"https://docs.temporal.io/typescript/workflows#sleep"},"sleepUntil")," and ",(0,a.kt)("a",{parentName:"p",href:"https://docs.temporal.io/typescript/workflows#async-design-patterns"},"Updatable Timers"),"."),(0,a.kt)("h2",{id:"data-model"},"Data Model"),(0,a.kt)("p",null,"We are about to start charging for money and adding more settable properties like ",(0,a.kt)("inlineCode",{parentName:"p"},"BillingPeriod")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"BillingPeriodChargeAmount"),".\nIt's time to evolve the data model accordingly.\nWe'll define a shared type:"),(0,a.kt)(r.Z,{groupId:"language",defaultValue:"ts",values:[{label:"TypeScript",value:"ts"},{label:"JavaScript",value:"js"}],mdxType:"Tabs"},(0,a.kt)(l.Z,{value:"ts",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"export type Customer = {\n  email: string;\n  trialPeriod: number;\n  billingPeriod: number;\n  maxBillingPeriods: number;\n  initialBillingPeriodCharge: number;\n  id: string;\n};\n"))),(0,a.kt)(l.Z,{value:"js",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"// Not required in JavaScript\n")))),(0,a.kt)("p",null,"And refactor our existing Workflow and Client code accordingly.\nWe'll spare you the gory details - you can always ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/temporalio/subscription-workflow-project-template-typescript"},"check our repo")," if you like, but there is no right answer here."),(0,a.kt)("h2",{id:"write-the-billing-process"},"Write the Billing Process"),(0,a.kt)("p",null,"We are now at Requirement 3:"),(0,a.kt)("blockquote",null,(0,a.kt)("ul",{parentName:"blockquote"},(0,a.kt)("li",{parentName:"ul"},"As long as you have not exceeded ",(0,a.kt)("inlineCode",{parentName:"li"},"MaxBillingPeriods"),","),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Charge the customer")," for the ",(0,a.kt)("inlineCode",{parentName:"li"},"BillingPeriodChargeAmount"),"."),(0,a.kt)("li",{parentName:"ul"},"Then wait for the next ",(0,a.kt)("inlineCode",{parentName:"li"},"BillingPeriod"),"."),(0,a.kt)("li",{parentName:"ul"},"If the customer cancels during a billing period, ",(0,a.kt)("strong",{parentName:"li"},"send a subscription cancellation email"),"."))),(0,a.kt)("p",null,"You should have all you need for writing the billing process code here; you are encouraged to take the exercise of writing this yourself."),(0,a.kt)("details",null,(0,a.kt)("summary",null,"Check your answer with ours."),(0,a.kt)(r.Z,{groupId:"language",defaultValue:"ts",values:[{label:"TypeScript",value:"ts"},{label:"JavaScript",value:"js"}],mdxType:"Tabs"},(0,a.kt)(l.Z,{value:"ts",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"// /src/workflows.ts\n// ...\nexport async function SubscriptionWorkflow(customer: Customer) {\n  let trialCanceled = false;\n  wf.setHandler(cancelSignal, () => void (trialCanceled = true));\n  await acts.sendWelcomeEmail(customer);\n  if (await wf.condition(() => trialCanceled, trialPeriod)) {\n    await acts.sendCancellationEmailDuringTrialPeriod(customer);\n  } else {\n    await BillingCycle(customer);\n  }\n}\n\n// break out a workflow into smaller function for code organization\n// this is NOT a child workflow!\nasync function BillingCycle(customer: Customer) {\n  let isCanceled = false;\n  wf.setHandler(cancelSignal, () => void (isCanceled = true)); // signals are reusable!\n  await acts.chargeCustomerForBillingPeriod(customer);\n  for (let num = 0; num < customer.maxBillingPeriods; num++) {\n    // Wait 1 billing period to charge customer or if they cancel subscription\n    // whichever comes first\n    if (await wf.condition(() => isCanceled, customer.billingPeriod)) {\n      // If customer cancelled their subscription send notification email\n      await acts.sendCancellationEmailDuringActiveSubscription(customer);\n      break;\n    } else {\n      await acts.chargeCustomerForBillingPeriod(customer);\n    }\n  }\n  // if we get here the subscription period is over\n  if (!isCanceled) await acts.sendSubscriptionOverEmail(customer);\n}\n"))),(0,a.kt)(l.Z,{value:"js",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"// /src/workflows.ts\n// ...\nexport async function SubscriptionWorkflow(customer) {\n  let trialCanceled = false;\n  wf.setHandler(cancelSignal, () => void (trialCanceled = true));\n  await acts.sendWelcomeEmail(customer);\n  if (await wf.condition(() => trialCanceled, trialPeriod)) {\n    await acts.sendCancellationEmailDuringTrialPeriod(customer);\n  }\n  else {\n    await BillingCycle(customer);\n  }\n}\n\n// break out a workflow into smaller function for code organization\n// this is NOT a child workflow!\nasync function BillingCycle(customer) {\n  let isCanceled = false;\n  wf.setHandler(cancelSignal, () => void (isCanceled = true)); // signals are reusable!\n  await acts.chargeCustomerForBillingPeriod(customer);\n  for (let num = 0; num < customer.maxBillingPeriods; num++) {\n    // Wait 1 billing period to charge customer or if they cancel subscription\n    // whichever comes first\n    if (await wf.condition(() => isCanceled, customer.billingPeriod)) {\n      // If customer cancelled their subscription send notification email\n      await acts.sendCancellationEmailDuringActiveSubscription(customer);\n      break;\n    }\n    else {\n      await acts.chargeCustomerForBillingPeriod(customer);\n    }\n  }\n  // if we get here the subscription period is over\n  if (!isCanceled)\n    await acts.sendSubscriptionOverEmail(customer);\n}\n"))))),(0,a.kt)("p",null,"Again, check that you can run your Workflow, and everything works as expected, including cancelling halfway through the trial or the billing periods."),(0,a.kt)("h2",{id:"queries-and-reusable-functions"},"Queries and Reusable Functions"),(0,a.kt)("p",null,"The last requirement is about being able to look up (and change) customer info.\nThe complement to Signals is Queries, where we can get data out of a running Workflow, and they have a very similar API:"),(0,a.kt)(r.Z,{groupId:"language",defaultValue:"ts",values:[{label:"TypeScript",value:"ts"},{label:"JavaScript",value:"js"}],mdxType:"Tabs"},(0,a.kt)(l.Z,{value:"ts",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"// not suggested code - just for illustrative purposes\nconst amountChargedQuery = wf.defineQuery<number>('amountChargedQuery');\nconst updateAmountCharged = wf.defineSignal<number>('updateAmountCharged');\n\n// inside Workflow\nlet amountCharged = customer.initialBillingPeriodCharge;\nwf.setHandler(amountChargedQuery, () => amountCharged);\nwf.setHandler(\n  updateAmountCharged,\n  (newAmount: number) => void (amountCharged = newAmount)\n);\n// do stuff with amountCharged\n"))),(0,a.kt)(l.Z,{value:"js",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"// not suggested code - just for illustrative purposes\nconst amountChargedQuery = wf.defineQuery('amountChargedQuery');\nconst updateAmountCharged = wf.defineSignal('updateAmountCharged');\n\n// inside Workflow\nlet amountCharged = customer.initialBillingPeriodCharge;\nwf.setHandler(amountChargedQuery, () => amountCharged);\nwf.setHandler(updateAmountCharged, (newAmount) => void (amountCharged = newAmount));\n// do stuff with amountCharged\n")))),(0,a.kt)("p",null,"You can set up Signals and Queries and Handlers for every field, or perhaps just one set for the entire Customer object, it depends on your needs.\nBut these primitives can be flexibly rearranged (with specific inspiration from React Custom Hooks) to reduce boilerplate for your needs, ",(0,a.kt)("a",{parentName:"p",href:"https://docs.temporal.io/typescript/workflows#signals-and-queries-design-patterns"},"as we have documented"),"."),(0,a.kt)("p",null,"Knowledge check time - Write scripts with Temporal Clients for:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"making the queries"),(0,a.kt)("li",{parentName:"ul"},"signalling updates in charge amount")),(0,a.kt)("p",null,"You can always ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/temporalio/subscription-workflow-project-template-typescript/blob/main/src/scripts/query-billinginfo.ts"},"refer to our repo")," if you get stuck."),(0,a.kt)("p",null,"Note that Signal handlers cannot return data, and Query handlers must not mutate state. These restrictions and other notes on type safety are ",(0,a.kt)("a",{parentName:"p",href:"https://docs.temporal.io/typescript/workflows#additional-signals-and-queries-notes"},"prominently noted in their documentation"),"."),(0,a.kt)("h2",{id:"end-result"},"End Result"),(0,a.kt)("details",null,(0,a.kt)("summary",null,"One possible solution"),(0,a.kt)(r.Z,{groupId:"language",defaultValue:"ts",values:[{label:"TypeScript",value:"ts"},{label:"JavaScript",value:"js"}],mdxType:"Tabs"},(0,a.kt)(l.Z,{value:"ts",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"// /src/workflows.ts\n// ...\nexport async function SubscriptionWorkflow(customer: Customer) {\n  let trialCanceled = false;\n  wf.setHandler(cancelSignal, () => void (trialCanceled = true));\n  await acts.sendWelcomeEmail(customer.value.email);\n  if (await wf.condition(() => trialCanceled, trialPeriod)) {\n    await acts.sendCancellationEmailDuringTrialPeriod(customer.value.email);\n  } else {\n    await BillingCycle(customer);\n  }\n}\n\nasync function BillingCycle(_customer: Customer) {\n  const customer = useState('customer', _customer); // wrapped up signals + queries + state\n  const period = useState('period', 0); // same\n  let isCanceled = false;\n  wf.setHandler(cancelSignal, () => void (isCanceled = true));\n  await acts.chargeCustomerForBillingPeriod(customer);\n  for (; period.value < customer.value.maxBillingPeriods; period.value++) {\n    // Wait 1 billing period to charge customer or if they cancel subscription\n    // whichever comes first\n    if (await wf.condition(() => isCanceled, customer.billingPeriod)) {\n      // If customer cancelled their subscription send notification email\n      await acts.sendCancellationEmailDuringActiveSubscription(customer);\n      break;\n    } else {\n      await acts.chargeCustomerForBillingPeriod(customer);\n    }\n  }\n  // if we get here the subscription period is over\n  if (!isCanceled) await acts.sendSubscriptionOverEmail(customer);\n}\n\n// standard utility https://docs.temporal.io/dev-guide/typescript/features#signals\nfunction useState<T = any>(name: string, initialValue: T) {\n  const signal = wf.defineSignal<[T]>(name);\n  const query = wf.defineQuery<T>(name);\n  let state: T = initialValue;\n  wf.setHandler(signal, (newVal: T) => void (newVal = state));\n  wf.setHandler(query, () => state);\n  return {\n    signal,\n    query,\n    get value() {\n      return state;\n    },\n    set value(newVal: T) {\n      state = newVal;\n    },\n  };\n}\n"))),(0,a.kt)(l.Z,{value:"js",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"// /src/workflows.ts\n// ...\nexport async function SubscriptionWorkflow(customer) {\n  let trialCanceled = false;\n  wf.setHandler(cancelSignal, () => void (trialCanceled = true));\n  await acts.sendWelcomeEmail(customer.value.email);\n  if (await wf.condition(() => trialCanceled, trialPeriod)) {\n    await acts.sendCancellationEmailDuringTrialPeriod(customer.value.email);\n  }\n  else {\n    await BillingCycle(customer);\n  }\n}\n\nasync function BillingCycle(_customer) {\n  const customer = useState('customer', _customer); // wrapped up signals + queries + state\n  const period = useState('period', 0); // same\n  let isCanceled = false;\n  wf.setHandler(cancelSignal, () => void (isCanceled = true));\n  await acts.chargeCustomerForBillingPeriod(customer);\n  for (; period.value < customer.value.maxBillingPeriods; period.value++) {\n    // Wait 1 billing period to charge customer or if they cancel subscription\n    // whichever comes first\n    if (await wf.condition(() => isCanceled, customer.billingPeriod)) {\n      // If customer cancelled their subscription send notification email\n      await acts.sendCancellationEmailDuringActiveSubscription(customer);\n      break;\n    }\n    else {\n      await acts.chargeCustomerForBillingPeriod(customer);\n    }\n  }\n  // if we get here the subscription period is over\n  if (!isCanceled)\n    await acts.sendSubscriptionOverEmail(customer);\n}\n\n// standard utility https://docs.temporal.io/dev-guide/typescript/features#signals\nfunction useState(name, initialValue) {\n  const signal = wf.defineSignal(name);\n  const query = wf.defineQuery(name);\n  let state = initialValue;\n  wf.setHandler(signal, (newVal) => void (newVal = state));\n  wf.setHandler(query, () => state);\n  return {\n    signal,\n    query,\n    get value() {\n      return state;\n    },\n    set value(newVal) {\n      state = newVal;\n    },\n  };\n}\n"))))),(0,a.kt)("h2",{id:"next-steps"},"Next Steps"),(0,a.kt)("p",null,"You should now be able to write a Workflow that uses Signals, Queries, ",(0,a.kt)("inlineCode",{parentName:"p"},"sleep"),", and ",(0,a.kt)("inlineCode",{parentName:"p"},"condition")," interchangeably and confidently.\nThese are meant to be low level primitives, and it is entirely expected that you will build up reusable functions and libraries with APIs you prefer as you proceed."),(0,a.kt)("p",null,"Two paths from here:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Go Full Stack"),": Integrate the manually-run Temporal Client scripts you have written here into an Express.js app, or serverless function.\nOur ",(0,a.kt)("a",{parentName:"li",href:"/tutorials/typescript/nextjs/"},"Next.js Tutorial")," should help show you how to integrate this with a frontend app, and give indications on how to deploy."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Learn More"),": Explore using ",(0,a.kt)("a",{parentName:"li",href:"https://docs.temporal.io/typescript/workflows#child-workflows"},"Child Workflows")," and ",(0,a.kt)("a",{parentName:"li",href:"https://docs.temporal.io/typescript/workflows#continueasnew"},(0,a.kt)("inlineCode",{parentName:"a"},"continueAsNew"))," so that your subscriptions can keep running indefinitely.")))}h.isMDXComponent=!0},2813:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/banner_typescript-2156b7edec5a96f12884d24603574199.png"}}]);