"use strict";(self.webpackChunktemporal_learning=self.webpackChunktemporal_learning||[]).push([[1182],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,s=e.parentName,p=r(e,["components","mdxType","originalType","parentName"]),d=u(n),m=o,h=d["".concat(s,".").concat(m)]||d[m]||c[m]||i;return n?a.createElement(h,l(l({ref:t},p),{},{components:n})):a.createElement(h,l({ref:t},p))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,l=new Array(i);l[0]=d;var r={};for(var s in t)hasOwnProperty.call(t,s)&&(r[s]=t[s]);r.originalType=e,r.mdxType="string"==typeof e?e:o,l[1]=r;for(var u=2;u<i;u++)l[u]=n[u];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},5162:(e,t,n)=>{n.d(t,{Z:()=>l});var a=n(7294),o=n(4334);const i="tabItem_Ymn6";function l(e){let{children:t,hidden:n,className:l}=e;return a.createElement("div",{role:"tabpanel",className:(0,o.Z)(i,l),hidden:n},t)}},4866:(e,t,n)=>{n.d(t,{Z:()=>v});var a=n(3117),o=n(7294),i=n(4334),l=n(6775),r=n(1980),s=n(7392),u=n(12);function p(e){return function(e){return o.Children.map(e,(e=>{if(!e||(0,o.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:t,label:n,attributes:a,default:o}}=e;return{value:t,label:n,attributes:a,default:o}}))}function c(e){const{values:t,children:n}=e;return(0,o.useMemo)((()=>{const e=t??p(n);return function(e){const t=(0,s.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function d(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function m(e){let{queryString:t=!1,groupId:n}=e;const a=(0,l.k6)(),i=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,r._X)(i),(0,o.useCallback)((e=>{if(!i)return;const t=new URLSearchParams(a.location.search);t.set(i,e),a.replace({...a.location,search:t.toString()})}),[i,a])]}function h(e){const{defaultValue:t,queryString:n=!1,groupId:a}=e,i=c(e),[l,r]=(0,o.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!d({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const a=n.find((e=>e.default))??n[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:t,tabValues:i}))),[s,p]=m({queryString:n,groupId:a}),[h,k]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[a,i]=(0,u.Nk)(n);return[a,(0,o.useCallback)((e=>{n&&i.set(e)}),[n,i])]}({groupId:a}),f=(()=>{const e=s??h;return d({value:e,tabValues:i})?e:null})();(0,o.useLayoutEffect)((()=>{f&&r(f)}),[f]);return{selectedValue:l,selectValue:(0,o.useCallback)((e=>{if(!d({value:e,tabValues:i}))throw new Error(`Can't select invalid tab value=${e}`);r(e),p(e),k(e)}),[p,k,i]),tabValues:i}}var k=n(2466),f=n(2389);const w="tabList__CuJ",y="tabItem_LNqP";function b(e){let{className:t,block:n,selectedValue:l,selectValue:r,tabValues:s}=e;const u=[],{blockElementScrollPositionUntilNextRender:p}=(0,k.o5)(),c=e=>{const t=e.currentTarget,n=u.indexOf(t),a=s[n].value;a!==l&&(p(t),r(a))},d=e=>{let t=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const n=u.indexOf(e.currentTarget)+1;t=u[n]??u[0];break}case"ArrowLeft":{const n=u.indexOf(e.currentTarget)-1;t=u[n]??u[u.length-1];break}}t?.focus()};return o.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.Z)("tabs",{"tabs--block":n},t)},s.map((e=>{let{value:t,label:n,attributes:r}=e;return o.createElement("li",(0,a.Z)({role:"tab",tabIndex:l===t?0:-1,"aria-selected":l===t,key:t,ref:e=>u.push(e),onKeyDown:d,onClick:c},r,{className:(0,i.Z)("tabs__item",y,r?.className,{"tabs__item--active":l===t})}),n??t)})))}function g(e){let{lazy:t,children:n,selectedValue:a}=e;const i=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=i.find((e=>e.props.value===a));return e?(0,o.cloneElement)(e,{className:"margin-top--md"}):null}return o.createElement("div",{className:"margin-top--md"},i.map(((e,t)=>(0,o.cloneElement)(e,{key:t,hidden:e.props.value!==a}))))}function _(e){const t=h(e);return o.createElement("div",{className:(0,i.Z)("tabs-container",w)},o.createElement(b,(0,a.Z)({},e,t)),o.createElement(g,(0,a.Z)({},e,t)))}function v(e){const t=(0,f.Z)();return o.createElement(_,(0,a.Z)({key:String(t)},e))}},5808:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>c,frontMatter:()=>i,metadata:()=>r,toc:()=>u});var a=n(3117),o=(n(7294),n(3905));n(5162),n(4866);const i={id:"subscription-tutorial",sidebar_position:3,keywords:["Python","temporal","sdk","tutorial","entity workflow","email subscription","sending emails"],tags:["Python","SDK"],last_update:{date:new Date("2024-03-06T00:00:00.000Z")},title:"Build an email subscription workflow with Temporal and Python",description:"Implement an email subscription application with Temporal's Workflows, Activities, and Queries, and allow users to start  your business logic through a web action.",image:"/img/temporal-logo-twitter-card.png"},l=void 0,r={unversionedId:"tutorials/python/subscriptions/subscription-tutorial",id:"tutorials/python/subscriptions/subscription-tutorial",title:"Build an email subscription workflow with Temporal and Python",description:"Implement an email subscription application with Temporal's Workflows, Activities, and Queries, and allow users to start  your business logic through a web action.",source:"@site/docs/tutorials/python/subscriptions/index.md",sourceDirName:"tutorials/python/subscriptions",slug:"/tutorials/python/subscriptions/",permalink:"/tutorials/python/subscriptions/",draft:!1,tags:[{label:"Python",permalink:"/tags/python"},{label:"SDK",permalink:"/tags/sdk"}],version:"current",lastUpdatedAt:1709683200,formattedLastUpdatedAt:"Mar 6, 2024",sidebarPosition:3,frontMatter:{id:"subscription-tutorial",sidebar_position:3,keywords:["Python","temporal","sdk","tutorial","entity workflow","email subscription","sending emails"],tags:["Python","SDK"],last_update:{date:"2024-03-06T00:00:00.000Z"},title:"Build an email subscription workflow with Temporal and Python",description:"Implement an email subscription application with Temporal's Workflows, Activities, and Queries, and allow users to start  your business logic through a web action.",image:"/img/temporal-logo-twitter-card.png"},sidebar:"tutorialSidebar",previous:{title:"Build a data pipeline Workflow with Temporal and Python",permalink:"/tutorials/python/data-pipelines/"},next:{title:"PHP tutorials",permalink:"/tutorials/php/"}},s={},u=[{value:"Introduction",id:"introduction",level:3},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Develop the Workflow",id:"develop-the-workflow",level:2},{value:"Develop an Activity",id:"develop-an-activity",level:2},{value:"Create the Worker to handle the Workflow and Activity Executions",id:"create-the-worker-to-handle-the-workflow-and-activity-executions",level:2},{value:"Build the API server to handle subscription requests",id:"build-the-api-server-to-handle-subscription-requests",level:2},{value:"Add a Query",id:"add-a-query",level:2},{value:"Unsubscribe users with a Workflow Cancellation Request",id:"unsubscribe-users-with-a-workflow-cancellation-request",level:2},{value:"Create an integration test",id:"create-an-integration-test",level:2},{value:"Conclusion",id:"conclusion",level:2}],p={toc:u};function c(e){let{components:t,...i}=e;return(0,o.kt)("wrapper",(0,a.Z)({},p,i,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Temporal Python SDK",src:n(289).Z,width:"902",height:"254"})),(0,o.kt)("h3",{id:"introduction"},"Introduction"),(0,o.kt)("p",null,"In this tutorial, you'll build an email subscription web application using Temporal and Python. You'll create a web server using the ",(0,o.kt)("a",{parentName:"p",href:"https://flask.palletsprojects.com/"},"Flask")," framework to handle requests and use Temporal Workflows, Activities, and Queries to build the core of the application. Your web server will handle requests from the end user and interact with a Temporal Workflow to manage the email subscription process. Since you're building the business logic with Temporal's Workflows and Activities, you'll be able to use Temporal to manage each subscription rather than relying on a separate database or task queue. This reduces the complexity of the code you have to write and support."),(0,o.kt)("p",null,"You'll create an endpoint for users to give their email address, and then create a new Workflow execution using that email address which will simulate sending an email message at certain intervals. The user can check on the status of their subscription, which you'll handle using a Query, and they can end the subscription at any time by unsubscribing, which you'll handle by cancelling the Workflow Execution. You can view the user's entire process through Temporal's Web UI. For this tutorial, you'll simulate sending emails, but you can adapt this example to call a live email service in the future."),(0,o.kt)("p",null,"By the end of this tutorial, you'll have a clear understand how to use Temporal to create and manage long-running Workflows within a web application."),(0,o.kt)("p",null,"You'll find the code for this tutorial on GitHub in the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-python"},"email-subscription-project-python")," repository."),(0,o.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,o.kt)("p",null,"Before starting this tutorial:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/getting_started/python/dev_environment/"},"Set up a local development environment for Temporal and Python"),"."),(0,o.kt)("li",{parentName:"ul"},"Complete the ",(0,o.kt)("a",{parentName:"li",href:"/getting_started/python/hello_world_in_python/"},"Hello World")," tutorial to ensure you understand the basics of creating Workflows and Activities with Temporal.")),(0,o.kt)("h2",{id:"develop-the-workflow"},"Develop the Workflow"),(0,o.kt)("p",null,"A Workflow defines a sequence of steps defined by writing code, known as a Workflow Definition, and are carried out by running that code, which results in a Workflow Execution."),(0,o.kt)("p",null,"The Temporal Python SDK recommends the use of a single ",(0,o.kt)("a",{parentName:"p",href:"https://docs.python.org/3/library/dataclasses.html"},"data class")," for parameters and return types. This lets you add fields without breaking compatibility. Before writing the Workflow Definition, you'll define the data objects used by the Workflow Definitions. You'll also define the Task Queue name you'll use in your Worker."),(0,o.kt)("p",null,"Create a new file called ",(0,o.kt)("inlineCode",{parentName:"p"},"shared_objects.py")," in your project directory."),(0,o.kt)("p",null,"Add the following code to the ",(0,o.kt)("inlineCode",{parentName:"p"},"shared_objects.py")," file which will:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Import the ",(0,o.kt)("inlineCode",{parentName:"li"},"dataclasses")," library."),(0,o.kt)("li",{parentName:"ol"},"Set the Task Queue variable name to ",(0,o.kt)("inlineCode",{parentName:"li"},"email_subscription"),"."),(0,o.kt)("li",{parentName:"ol"},"Add ",(0,o.kt)("inlineCode",{parentName:"li"},"WorkflowOptions")," and ",(0,o.kt)("inlineCode",{parentName:"li"},"EmailDetails")," data classes.")),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-python/blob/main/shared_objects.py"},"shared_objects.py")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},'from dataclasses import dataclass\n\ntask_queue_name = "email_subscription"\n\n\n@dataclass\nclass WorkflowOptions:\n    email: str\n\n\n@dataclass\nclass EmailDetails:\n    email: str = ""\n    message: str = ""\n    count: int = 0\n    subscribed: bool = False\n\n\n')),(0,o.kt)("p",null,"The following describes each data class and their objects."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"WorkflowOptions"),": this data class starts the Workflow Execution.",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"It will contain the following field:",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"email"),": a string to pass the user's email"))))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"EmailDetails"),": this data class holds data about the current state of the subscription.",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"It will contain the following field:",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"email"),": as a string to pass a user's email"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"message"),": as a string to pass a message to the user"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"count"),": as an integer to track the number of emails sent"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"subscribed"),": as a boolean to track whether the user is currently subscribed")))))),(0,o.kt)("p",null,"When you Query your Workflow to retrieve the current statue of the Workflow, you'll use the ",(0,o.kt)("inlineCode",{parentName:"p"},"EmailDetails")," data class."),(0,o.kt)("p",null,"Now that you have the Task Queue and the data classes defined, you can write the Workflow Definition."),(0,o.kt)("p",null,"To create a new Workflow Definition, create a new file called ",(0,o.kt)("inlineCode",{parentName:"p"},"workflows.py"),". This file will contain the ",(0,o.kt)("inlineCode",{parentName:"p"},"SendEmailWorkflow")," class and its attributes."),(0,o.kt)("p",null,"Use the ",(0,o.kt)("inlineCode",{parentName:"p"},"workflows.py")," file to write deterministic logic inside your Workflow Definition and to ",(0,o.kt)("a",{parentName:"p",href:"https://python.temporal.io/temporalio.workflow.html#execute_activity"},"execute the Activity"),"."),(0,o.kt)("p",null,"Add the following code to define the Workflow:"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-python/blob/main/workflows.py"},"workflows.py")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},'\nimport asyncio\nfrom datetime import timedelta\n\nfrom temporalio import workflow\n\nwith workflow.unsafe.imports_passed_through():\n    from activities import send_email\n    from shared_objects import EmailDetails, WorkflowOptions\n\n\n@workflow.defn\nclass SendEmailWorkflow:\n    def __init__(self) -> None:\n        self.email_details = EmailDetails()\n\n    @workflow.run\n    async def run(self, data: WorkflowOptions) -> None:\n        duration = 12\n        self.email_details.email = data.email\n        self.email_details.message = "Welcome to our Subscription Workflow!"\n        self.email_details.subscribed = True\n        self.email_details.count = 0\n\n        while self.email_details.subscribed:\n            self.email_details.count += 1\n            if self.email_details.count > 1:\n                self.email_details.message = "Thank you for staying subscribed!"\n\n            try:\n                await workflow.execute_activity(\n                    send_email,\n                    self.email_details,\n                    start_to_close_timeout=timedelta(seconds=10),\n                )\n                await asyncio.sleep(duration)\n\n            except asyncio.CancelledError as err:\n                # Cancelled by the user. Send them a goodbye message.\n                self.email_details.subscribed = False\n                self.email_details.message = "Sorry to see you go"\n                await workflow.execute_activity(\n                    send_email,\n                    self.email_details,\n                    start_to_close_timeout=timedelta(seconds=10),\n                )\n                # raise error so workflow shows as cancelled.\n                raise err\n\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"run()")," method, decorated with ",(0,o.kt)("inlineCode",{parentName:"p"},"@workflow.run"),", takes in the email address as an argument. This method initializes the ",(0,o.kt)("inlineCode",{parentName:"p"},"_email"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"_message"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"_subscribed"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"_count")," attributes of the ",(0,o.kt)("inlineCode",{parentName:"p"},"SendEmailWorkflow")," instance."),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"SendEmailWorkflow")," class has a loop that checks if the subscription is active by checking if ",(0,o.kt)("inlineCode",{parentName:"p"},"self.email_details.subscribed")," is True. If it is, it starts the ",(0,o.kt)("inlineCode",{parentName:"p"},"send_email()")," Activity."),(0,o.kt)("p",null,"The while loop increments the ",(0,o.kt)("inlineCode",{parentName:"p"},"self.email_details.count"),"  attribute and calls the ",(0,o.kt)("inlineCode",{parentName:"p"},"send_email()")," Activity with the current ",(0,o.kt)("inlineCode",{parentName:"p"},"EmailDetails")," object. The loop continues as long as the ",(0,o.kt)("inlineCode",{parentName:"p"},"self.email_details.subscribed")," attribute is true."),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"execute_activity()")," method executes the ",(0,o.kt)("inlineCode",{parentName:"p"},"send_email()")," Activity with the following parameters:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("inlineCode",{parentName:"li"},"send_email()")," Activity Definition"),(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("inlineCode",{parentName:"li"},"EmailDetails")," data class"),(0,o.kt)("li",{parentName:"ul"},"A ",(0,o.kt)("inlineCode",{parentName:"li"},"start_to_close_timeout")," parameter, which tells the Temporal Server to time out the Activity 10 seconds from when the Activity starts")),(0,o.kt)("p",null,"The loop also includes a ",(0,o.kt)("inlineCode",{parentName:"p"},"asyncio.sleep()")," statement that causes the Workflow to pause for a set amount of time between email. You can define this in seconds, days, months, or even years, depending on your business logic."),(0,o.kt)("p",null,"If there's a cancellation request, the request raises ",(0,o.kt)("inlineCode",{parentName:"p"},"asyncio.CancelledError"),", which you can catch and respond. In this application, you'll use cancellation requests to unsubscribe users. You'll send one last email when they unsubscribe, before completing the Workflow Execution."),(0,o.kt)("p",null,"Since the user's email address is set to the Workflow Id, attempting to subscribe with the same email address twice will result in a ",(0,o.kt)("inlineCode",{parentName:"p"},"Workflow Execution already started")," error and prevent the Workflow Execution from spawning again."),(0,o.kt)("p",null,"Therefore, only one running Workflow Execution per email address can exist within the associated Namespace. This ensures that the user won't receive multiple email subscriptions. This also helps reduce the complexity of the code you have to write and maintain."),(0,o.kt)("p",null,"With this Workflow Definition in place, you can now develop an Activity to send emails."),(0,o.kt)("h2",{id:"develop-an-activity"},"Develop an Activity"),(0,o.kt)("p",null,"You'll need an Activity to send the email to the subscriber so you can handle failures."),(0,o.kt)("p",null,"Create a new file called ",(0,o.kt)("inlineCode",{parentName:"p"},"activities.py")," and add the following code to define the asynchronous Activity Definition:"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-python/blob/main/activities.py"},"activities.py")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},'from temporalio import activity\n\nfrom shared_objects import EmailDetails\n\n\n@activity.defn\nasync def send_email(details: EmailDetails) -> str:\n    print(\n        f"Sending email to {details.email} with message: {details.message}, count: {details.count}"\n    )\n    return "success"\n')),(0,o.kt)("p",null,"This implementation only prints a message, but you could replace the implementation with one that uses an email API."),(0,o.kt)("p",null,"Each iteration of the Workflow loop will execute this Activity, which simulates sending a message to the user."),(0,o.kt)("p",null,"Now that you have the Activity Definition and Workflow Definition, it's time to write the Worker process."),(0,o.kt)("h2",{id:"create-the-worker-to-handle-the-workflow-and-activity-executions"},"Create the Worker to handle the Workflow and Activity Executions"),(0,o.kt)("p",null,"Create a new file called ",(0,o.kt)("inlineCode",{parentName:"p"},"run_worker.py")," and develop the Worker process to execute your Workflow and Activity Definitions."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-python/blob/main/run_worker.py"},"run_worker.py")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},'import asyncio\n\nfrom temporalio.client import Client\nfrom temporalio.worker import Worker\n\nfrom activities import send_email\nfrom shared_objects import task_queue_name\nfrom workflows import SendEmailWorkflow\n\n\nasync def main():\n    client = await Client.connect("localhost:7233")\n\n    worker = Worker(\n        client,\n        task_queue=task_queue_name,\n        workflows=[SendEmailWorkflow],\n        activities=[send_email],\n    )\n    await worker.run()\n\n\nif __name__ == "__main__":\n    asyncio.run(main())\n')),(0,o.kt)("p",null,"Now that you've written the logic to execute the Workflow and Activity Definitions, try to build the gateway."),(0,o.kt)("h2",{id:"build-the-api-server-to-handle-subscription-requests"},"Build the API server to handle subscription requests"),(0,o.kt)("p",null,"This tutorial uses the Flask web framework to build a web server that acts as the entry point for initiating Workflow Execution and communicating with the ",(0,o.kt)("inlineCode",{parentName:"p"},"subscribe"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"get-details"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"unsubscribe")," routes. The web server will handle HTTP requests and perform the appropriate operations with the Workflow."),(0,o.kt)("p",null,"Create a new file called ",(0,o.kt)("inlineCode",{parentName:"p"},"run_flask.py")," to develop your Flask endpoints."),(0,o.kt)("p",null,"First, register the Temporal Client function to run before the first request to this instance of the application.  A Temporal Client enables you to communicate with the Temporal Cluster.\nCommunication with a Temporal Cluster includes, but isn't limited to, the following:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Starting Workflow Executions"),(0,o.kt)("li",{parentName:"ul"},"Sending Queries to Workflow Executions"),(0,o.kt)("li",{parentName:"ul"},"Getting the results of a Workflow Execution")),(0,o.kt)("p",null,"Add the following code to import your libraries and connect to the Temporal Server."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-python/blob/main/run_flask.py"},"run_flask.py")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},'# ...\nimport asyncio\n\nfrom flask import Flask, current_app, jsonify, make_response, request\nfrom temporalio.client import Client\n\nfrom run_worker import SendEmailWorkflow\nfrom shared_objects import WorkflowOptions, task_queue_name\n\napp = Flask(__name__)\n\n\nasync def connect_temporal(app):\n    client = await Client.connect("localhost:7233")\n    app.temporal_client = client\n\n\ndef get_client() -> Client:\n    return current_app.temporal_client\n\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"get_client()")," function retrieves the Client connection from the Flask app once it's initialized. You'll use this in your endpoints."),(0,o.kt)("p",null,"Now that your connection to the Temporal Server is open, define your first Flask endpoint."),(0,o.kt)("p",null,"First, build the ",(0,o.kt)("inlineCode",{parentName:"p"},"/subscribe")," endpoint."),(0,o.kt)("p",null,"In the ",(0,o.kt)("inlineCode",{parentName:"p"},"run_flask.py")," file, define a ",(0,o.kt)("inlineCode",{parentName:"p"},"/subscribe")," endpoint as an asynchronous function, so that users can subscribe to the emails."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-python/blob/main/run_flask.py"},"run_flask.py")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},'# ...\n@app.route("/subscribe", methods=["POST"])\nasync def start_subscription():\n    client = get_client()\n\n    email: str = str(request.json.get("email"))\n    data: WorkflowOptions = WorkflowOptions(email=email)\n    await client.start_workflow(\n        SendEmailWorkflow.run,\n        data,\n        id=data.email,\n        task_queue=task_queue_name,\n    )\n\n    message = jsonify({"message": "Resource created successfully"})\n    response = make_response(message, 201)\n    return response\n')),(0,o.kt)("p",null,"In the ",(0,o.kt)("inlineCode",{parentName:"p"},"start_subscription()")," function, get the Temporal Server connection from the Flask application.\nThe ",(0,o.kt)("inlineCode",{parentName:"p"},"WorkflowOptions")," object is used to pass the email address given by the user to the Workflow Execution and sets the Workflow Id. This ensures that the email is unique across all Workflows so that the user can't sign up multiple times, only receive the emails they've subscribed to, and when they cancel; they cancel the Workflow run."),(0,o.kt)("p",null,"With this endpoint in place, you can now send a POST request to ",(0,o.kt)("inlineCode",{parentName:"p"},"/subscribe")," with an email address in the request body to start a new Workflow that sends an email to that address."),(0,o.kt)("p",null,"But how would you get details about the subscription? In the next section, you'll query your Workflow to get back information on the state of things in the next section."),(0,o.kt)("h2",{id:"add-a-query"},"Add a Query"),(0,o.kt)("p",null,"Now create a method in which a user can get information about their subscription details.\nAdd a new method called ",(0,o.kt)("inlineCode",{parentName:"p"},"details()")," to the ",(0,o.kt)("inlineCode",{parentName:"p"},"SendEmailWorkflow")," class and use the ",(0,o.kt)("inlineCode",{parentName:"p"},"@workflow.query")," decorator."),(0,o.kt)("p",null,"To allow users to retrieve information about their subscription details, add a new method called ",(0,o.kt)("inlineCode",{parentName:"p"},"details()")," to the ",(0,o.kt)("inlineCode",{parentName:"p"},"SendEmailWorkflow")," class in the ",(0,o.kt)("inlineCode",{parentName:"p"},"workflows.py")," file. Decorate this method with ",(0,o.kt)("inlineCode",{parentName:"p"},"@workflow.query"),"."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-python/blob/main/workflows.py"},"workflows.py")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"# ...\n    @workflow.query\n    def details(self) -> EmailDetails:\n        return self.email_details\n")),(0,o.kt)("p",null,"The email_details object is an instance of ",(0,o.kt)("inlineCode",{parentName:"p"},"EmailDetails"),".\nQueries can be used even if after the Workflow completes, which is useful for when the user unsubscribes but still wants to retrieve information about their subscription."),(0,o.kt)("p",null,"Queries should never mutate anything in the Workflow."),(0,o.kt)("p",null,"Now that you've added the ability to Query your Workflow, add the ability to Query from the Flask application."),(0,o.kt)("p",null,"To enable users to query the Workflow from the Flask application, add a new endpoint called ",(0,o.kt)("inlineCode",{parentName:"p"},"/get_details")," to the ",(0,o.kt)("inlineCode",{parentName:"p"},"run_flask.py")," file."),(0,o.kt)("p",null,"Use the ",(0,o.kt)("a",{parentName:"p",href:"https://python.temporal.io/temporalio.client.Client.html#get_workflow_handle"},"get_workflow_handle()")," function to return a Workflow handle by a Workflow Id."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-python/blob/main/run_flask.py"},"run_flask.py")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},'# ...\n@app.route("/get_details", methods=["GET"])\nasync def get_query():\n    client = get_client()\n    email = request.args.get("email")\n    handle = client.get_workflow_handle_for(SendEmailWorkflow.run, email)\n    results = await handle.query(SendEmailWorkflow.details)\n    message = jsonify(\n        {\n            "email": results.email,\n            "message": results.message,\n            "subscribed": results.subscribed,\n            "numberOfEmailsSent": results.count,\n        }\n    )\n\n    response = make_response(message, 200)\n    return response\n')),(0,o.kt)("p",null,"Using ",(0,o.kt)("inlineCode",{parentName:"p"},"handle.query()")," creates a Handle on the Workflow and calls the Query method on the handle to get the value of the variables.\nThis function enables you to return all the information about the user's email subscription that's declared in the Workflow."),(0,o.kt)("p",null,"Now that users can subscribe and view the details of their subscription, you need to provide them with a way to unsubscribe."),(0,o.kt)("h2",{id:"unsubscribe-users-with-a-workflow-cancellation-request"},"Unsubscribe users with a Workflow Cancellation Request"),(0,o.kt)("p",null,"Users will want to unsubscribe from the email list at some point, so give them a way to do that."),(0,o.kt)("p",null,"You cancel a Workflow by sending a cancellation request to the Workflow Execution. Your Workflow code can respond to this cancellation and perform additional operations in response. This is how you will handle unsubscribe requests."),(0,o.kt)("p",null,"With the ",(0,o.kt)("inlineCode",{parentName:"p"},"run_flask.py")," file open, add a new endpoint called ",(0,o.kt)("inlineCode",{parentName:"p"},"/unsubscribe")," to the Flask application."),(0,o.kt)("p",null,"To send a cancellation notice to an endpoint, use the HTTP ",(0,o.kt)("inlineCode",{parentName:"p"},"DELETE")," method on the ",(0,o.kt)("inlineCode",{parentName:"p"},"unsubscribe")," endpoint to return a ",(0,o.kt)("a",{parentName:"p",href:"https://python.temporal.io/temporalio.client.WorkflowHandle.html#cancel"},"cancel()")," method on the Workflow's handle."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-python/blob/main/run_flask.py"},"run_flask.py")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},'# ...\n\n@app.route("/unsubscribe", methods=["DELETE"])\nasync def end_subscription():\n    client = get_client()\n    email: str = str(request.json.get("email"))\n    handle = client.get_workflow_handle(\n        email,\n    )\n    await handle.cancel()\n    message = jsonify({"message": "Requesting cancellation"})\n\n    # Return 202 because this is a request to cancel and the API has accepted\n    # the request but has not processed yet.\n    response = make_response(message, 202)\n    return response\n\n\nif __name__ == "__main__":\n    # Create Temporal connection.\n    asyncio.run(connect_temporal(app))\n\n    # Start API\n    app.run(debug=True)\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"handle.cancel()")," method sends a cancellation request to the Workflow Execution that was started with the ",(0,o.kt)("inlineCode",{parentName:"p"},"/subscribe")," endpoint."),(0,o.kt)("p",null,"When the Temporal Service receives the cancellation request, it will cancel the Workflow Execution and return a ",(0,o.kt)("inlineCode",{parentName:"p"},"CancelledError")," to the Workflow Execution, which your Workflow Definition  already handles in the ",(0,o.kt)("inlineCode",{parentName:"p"},"try/except")," block. Here's the relevant section as a reminder:"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-python/blob/main/workflows.py"},"workflows.py")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},'# ...\n            try:\n                await workflow.execute_activity(\n                    send_email,\n                    self.email_details,\n                    start_to_close_timeout=timedelta(seconds=10),\n                )\n                await asyncio.sleep(duration)\n\n            except asyncio.CancelledError as err:\n                # Cancelled by the user. Send them a goodbye message.\n                self.email_details.subscribed = False\n                self.email_details.message = "Sorry to see you go"\n                await workflow.execute_activity(\n                    send_email,\n                    self.email_details,\n                    start_to_close_timeout=timedelta(seconds=10),\n                )\n                # raise error so workflow shows as cancelled.\n                raise err\n')),(0,o.kt)("p",null,"With this endpoint in place,  users can send a ",(0,o.kt)("inlineCode",{parentName:"p"},"DELETE")," request to ",(0,o.kt)("inlineCode",{parentName:"p"},"/unsubscribe")," with an email address in the request body to cancel the Workflow associated with that email address. This allows users to unsubscribe from the email list and prevent any further emails from sending."),(0,o.kt)("p",null,"Now that you've added the ability to unsubscribe from the email list, test your application code to ensure it works as expected."),(0,o.kt)("h2",{id:"create-an-integration-test"},"Create an integration test"),(0,o.kt)("p",null,"Integration testing is an essential part of software development that helps ensure that different components of an application work together correctly."),(0,o.kt)("p",null,"The Temporal Python SDK includes functions that help you test your Workflow Executions."),(0,o.kt)("p",null,"Workflow testing can be done in an integration test fashion against a ",(0,o.kt)("a",{parentName:"p",href:"https://python.temporal.io/temporalio.testing.WorkflowEnvironment.html#start_local"},"test server")," or from a ",(0,o.kt)("a",{parentName:"p",href:"https://python.temporal.io/temporalio.testing.WorkflowEnvironment.html#from_client"},"given Client"),"."),(0,o.kt)("p",null,"In this section, you'll write an integration test using the Temporal Python SDK to test the cancellation of a Workflow. Now, you can add tests to the application to ensure the Cancellation works as expected."),(0,o.kt)("p",null,"To set up the test environment, create two new files called ",(0,o.kt)("inlineCode",{parentName:"p"},"test_run_worker.py")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"__init__.py")," in the ",(0,o.kt)("inlineCode",{parentName:"p"},"tests")," directory."),(0,o.kt)("p",null,"The Temporal Python SDK includes functions that help you test your Workflow Executions. In this section, you will import the necessary modules and classes to test the cancellation of a Workflow."),(0,o.kt)("p",null,"In this code, you are defining two test functions ",(0,o.kt)("inlineCode",{parentName:"p"},"test_create_email()")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"test_cancel_workflow()")," that use the Temporal SDK to create and cancel a Workflow Execution."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/temporalio/email-subscription-project-python/blob/main/tests/test_run_worker.py"},"tests/test_run_worker.py")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},'\nimport pytest\nfrom temporalio.client import WorkflowExecutionStatus, WorkflowFailureError\nfrom temporalio.exceptions import CancelledError\nfrom temporalio.testing import WorkflowEnvironment\nfrom temporalio.worker import Worker\n\nfrom activities import send_email\nfrom run_worker import SendEmailWorkflow\nfrom shared_objects import EmailDetails\n\n\n@pytest.mark.asyncio\nasync def test_create_email() -> None:\n    task_queue_name: str = "email_subscription"\n\n    async with await WorkflowEnvironment.start_local() as env:\n        data: EmailDetails = EmailDetails(\n            email="test@example.com", message="Here\'s your message!"\n        )\n\n        async with Worker(\n            env.client,\n            task_queue=task_queue_name,\n            workflows=[SendEmailWorkflow],\n            activities=[send_email],\n        ):\n\n            handle = await env.client.start_workflow(\n                SendEmailWorkflow.run,\n                data,\n                id=data.email,\n                task_queue=task_queue_name,\n            )\n\n            assert WorkflowExecutionStatus.RUNNING == (await handle.describe()).status\n\n\n@pytest.mark.asyncio\nasync def test_cancel_workflow() -> None:\n    task_queue_name: str = "email_subscription"\n\n    async with await WorkflowEnvironment.start_local() as env:\n        data: EmailDetails = EmailDetails(\n            email="test@example.com", message="Here\'s your message!"\n        )\n\n        async with Worker(\n            env.client,\n            task_queue=task_queue_name,\n            workflows=[SendEmailWorkflow],\n            activities=[send_email],\n        ):\n\n            handle = await env.client.start_workflow(\n                SendEmailWorkflow.run,\n                data,\n                id=data.email,\n                task_queue=task_queue_name,\n            )\n\n            await handle.cancel()\n\n            # Cancelling a workflow requests cancellation. Need to wait for the\n            # workflow to complete.\n            with pytest.raises(WorkflowFailureError) as err:\n                await handle.result()\n\n            assert isinstance(err.value.cause, CancelledError)\n\n            assert WorkflowExecutionStatus.CANCELED == (await handle.describe()).status\n\n\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"test_create_email()")," function creates a Workflow Execution by starting the ",(0,o.kt)("inlineCode",{parentName:"p"},"SendEmailWorkflow")," with some test data. The function then asserts that the status of the Workflow Execution is ",(0,o.kt)("inlineCode",{parentName:"p"},"RUNNING"),"."),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"test_cancel_workflow()")," function also starts a Workflow Execution, but it then immediately cancels it using the ",(0,o.kt)("inlineCode",{parentName:"p"},"cancel()")," method on the Workflow's handle. It then waits for the Workflow Execution to complete and asserts that the status is ",(0,o.kt)("inlineCode",{parentName:"p"},"CANCELED"),". Finally, the function checks that the Workflow Execution was cancelled due to a ",(0,o.kt)("inlineCode",{parentName:"p"},"CancelledError"),"."),(0,o.kt)("p",null,"Now that you've created a test function for the Workflow Cancellation, run ",(0,o.kt)("inlineCode",{parentName:"p"},"pytest")," to see if that works."),(0,o.kt)("p",null,"To test the function, run ",(0,o.kt)("inlineCode",{parentName:"p"},"pytest")," from the command line to automatically discover and execute tests."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-output"},"============================= test session starts ==============================\nplatform darwin -- Python 3.11.3, pytest-7.2.2, pluggy-1.0.0\nrootdir: email-subscription-project-python, configfile: pyproject.toml\nplugins: asyncio-0.20.3, anyio-3.6.2\nasyncio: mode=Mode.AUTO\ncollected 2 items\n\ntests/test_run_worker.py::test_create_email\n-------------------------------- live log call ---------------------------------\n12:01:12 [    INFO] Beginning worker shutdown, will wait 0:00:00 before cancelling activities (_worker.py:425)\nPASSED                                                                   [ 50%]\ntests/test_run_worker.py::test_cancel_workflow\n-------------------------------- live log call ---------------------------------\n12:01:23 [    INFO] Beginning worker shutdown, will wait 0:00:00 before cancelling activities (_worker.py:425)\nPASSED                                                                   [100%]\n\n============================== 2 passed in 13.24s ==============================\n")),(0,o.kt)("p",null,"You've successfully written, executed, and passed a Cancellation Workflow test, just as you would any other code written in Python.\nTemporal's Python SDK provides a number of functions that help you test your Workflow Executions.\nBy following the best practices for testing your code, you can be confident that your Workflows are reliable and performant."),(0,o.kt)("h2",{id:"conclusion"},"Conclusion"),(0,o.kt)("p",null,"This tutorial demonstrates how to build an email subscription web application using Temporal and Python. By leveraging Temporal's Workflows, Activities, and Queries, the tutorial shows how to create a web server that interacts with Temporal to manage the email subscription process."),(0,o.kt)("p",null,"With this knowledge, you will be able to take on more complex Workflows and Activities to create even stronger applications."))}c.isMDXComponent=!0},289:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/banner_python-0d345d125b6892840c54f7e1460c8a5a.png"}}]);