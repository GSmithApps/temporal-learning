"use strict";(self.webpackChunktemporal_learning=self.webpackChunktemporal_learning||[]).push([[2337],{5997:(e,t,a)=>{a.d(t,{Zt:()=>s,yT:()=>o});var n=a(7294),i=a(2004);const o=function(e){let{url:t,loop:a,playing:o}=e;return n.createElement("div",{className:"relative rounded-lg shadow-lg",style:{position:"relative",paddingTop:"56.25%",marginBottom:20}},n.createElement(i.Z,{url:t,loop:a,playing:o,width:"100%",height:"100%",controls:!0,style:{position:"absolute",top:0,left:0}}))};a(4673);var r=a(3612);function s(){return n.createElement(r.Z,{type:"info",title:"WORK IN PROGRESS"},n.createElement("p",null,"This tutorial is a work in progress. Some sections may be incomplete, out of date, or missing. We're working to update it."))}},5133:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>p,contentTitle:()=>s,default:()=>d,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var n=a(3117),i=(a(7294),a(3905)),o=(a(5162),a(4866),a(5997));const r={id:"booking-saga-tutorial",sidebar_position:1,keywords:["PHP","temporal","sdk","tutorial","saga pattern","transactions","compensations"],tags:["PHP","SDK","Saga"],last_update:{date:new Date("2021-10-01T00:00:00.000Z")},title:"Create a trip booking system with the Saga pattern and Temporal in PHP",description:"In this tutorial, you'll explore the different components that make up the Temporal Booking Saga code sample.",image:"/img/temporal-logo-twitter-card.png"},s=void 0,l={unversionedId:"tutorials/php/booking_saga/booking-saga-tutorial",id:"tutorials/php/booking_saga/booking-saga-tutorial",title:"Create a trip booking system with the Saga pattern and Temporal in PHP",description:"In this tutorial, you'll explore the different components that make up the Temporal Booking Saga code sample.",source:"@site/docs/tutorials/php/booking_saga/index.md",sourceDirName:"tutorials/php/booking_saga",slug:"/tutorials/php/booking_saga/",permalink:"/tutorials/php/booking_saga/",draft:!1,tags:[{label:"PHP",permalink:"/tags/php"},{label:"SDK",permalink:"/tags/sdk"},{label:"Saga",permalink:"/tags/saga"}],version:"current",lastUpdatedAt:1633046400,formattedLastUpdatedAt:"Oct 1, 2021",sidebarPosition:1,frontMatter:{id:"booking-saga-tutorial",sidebar_position:1,keywords:["PHP","temporal","sdk","tutorial","saga pattern","transactions","compensations"],tags:["PHP","SDK","Saga"],last_update:{date:"2021-10-01T00:00:00.000Z"},title:"Create a trip booking system with the Saga pattern and Temporal in PHP",description:"In this tutorial, you'll explore the different components that make up the Temporal Booking Saga code sample.",image:"/img/temporal-logo-twitter-card.png"},sidebar:"tutorialSidebar",previous:{title:"PHP tutorials",permalink:"/tutorials/php/"},next:{title:"Subscription walkthrough with Temporal in PHP",permalink:"/tutorials/php/subscriptions/"}},p={},c=[{value:"Introduction",id:"introduction",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Review the Saga architecture pattern",id:"review-the-saga-architecture-pattern",level:2},{value:"Workflow implementation",id:"workflow-implementation",level:2},{value:"Write the Saga",id:"write-the-saga",level:3},{value:"Add compensations",id:"add-compensations",level:3},{value:"Run the compensation strategy",id:"run-the-compensation-strategy",level:3},{value:"Conclusion",id:"conclusion",level:2}],h={toc:c};function d(e){let{components:t,...r}=e;return(0,i.kt)("wrapper",(0,n.Z)({},h,r,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"Temporal PHP SDK",src:a(766).Z,width:"902",height:"254"})),(0,i.kt)(o.Zt,{mdxType:"OutdatedNotice"}),(0,i.kt)("h2",{id:"introduction"},"Introduction"),(0,i.kt)("p",null,"Imagine that we provide a service where people can book a trip. Booking a regular trip often consists of several steps:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Booking a car."),(0,i.kt)("li",{parentName:"ul"},"Booking a hotel."),(0,i.kt)("li",{parentName:"ul"},"Booking a flight.")),(0,i.kt)("p",null,"The customer either wants everything to be booked or nothing at all.  There is no sense in booking a hotel without booking a plane.  Also, imagine that each booking step in this transaction is represented via a dedicated service or microservice."),(0,i.kt)("p",null,"All of these steps together make up a  ",(0,i.kt)("strong",{parentName:"p"},"distributed transaction"),' that crosses multiple services and databases.  To ensure a successful booking, all three microservices must complete the individual local transactions.  If any of the steps fail, all the completed preceding transactions should be reversed accordingly.  We cannot simply "delete" the prior transactions or "go back in time" - Particularly where money and bookings are concerned, it is important to have an immutable record of attempts and failures. Therefore, we should accumulate a list of compensating actions to execute when failure occurs.'),(0,i.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/getting_started/php/dev_environment/"},"Set up a local development environment for developing Temporal applications using PHP")),(0,i.kt)("li",{parentName:"ul"},"Review the ",(0,i.kt)("a",{parentName:"li",href:"/getting_started/php/hello_world_in_php/"},"Hello World in PHP tutorial")," to  understood the basics of getting a Temporal PHP SDK project up and running. ")),(0,i.kt)("h2",{id:"review-the-saga-architecture-pattern"},"Review the Saga architecture pattern"),(0,i.kt)("p",null,"Managing distributed transactions can be difficult to do well. Sagas are one of the most ",(0,i.kt)("a",{parentName:"p",href:"https://www.cs.cornell.edu/andru/cs711/2002fa/reading/sagas.pdf"},"tried and tested")," design patterns for long running work:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"A Saga provides transaction management using a sequence of local transactions."),(0,i.kt)("li",{parentName:"ul"},"A local transaction is the unit of work performed by a saga participant, a microservice."),(0,i.kt)("li",{parentName:"ul"},"Every operation that is part of the Saga can be rolled back by a compensating transaction."),(0,i.kt)("li",{parentName:"ul"},"The Saga pattern guarantees that either all operations are completed successfully or the corresponding compensation transactions are run to undo the previously completed work.")),(0,i.kt)("p",null,"Implementing the Saga pattern can be complex, but fortunately, Temporal provides native support for the Saga pattern.\nIt means that handling all the rollbacks and running compensation transactions are performed internally by Temporal."),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"Booking saga flow",src:a(7356).Z,width:"2257",height:"1333"})),(0,i.kt)("p",null,"The above diagram shows how to visualize the Saga pattern for the previously discussed online trip booking scenario."),(0,i.kt)("h2",{id:"workflow-implementation"},"Workflow implementation"),(0,i.kt)("p",null,"The first thing we need to do is to write a business process - the high-level flow of the trip booking. Let's call\nit ",(0,i.kt)("inlineCode",{parentName:"p"},"TripBookingWorkflow"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"class TripBookingWorkflow implements TripBookingWorkflowInterface\n{\n    /** @var \\Temporal\\Internal\\Workflow\\ActivityProxy|TripBookingActivitiesInterface */\n    private $activities;\n\n    public function __construct()\n    {\n        $this->activities = Workflow::newActivityStub(\n            TripBookingActivitiesInterface::class,\n            ActivityOptions::new()->withStartToCloseTimeout(CarbonInterval::hour(1))\n        );\n    }\n\n    public function bookTrip(string $name)\n    {\n\n    }\n}\n")),(0,i.kt)("p",null,"For simplicity, let's assume that all booking services (car, hotel, and flight) are managed under one single\nactivity ",(0,i.kt)("inlineCode",{parentName:"p"},"TripBookingActivitiesInterface"),". But it is not a requirement. Ok, now we need to tell Temporal that\nwe are going to use Saga."),(0,i.kt)("admonition",{title:"Saga Orchestration Pattern",type:"info"},(0,i.kt)("p",{parentName:"admonition"},"There are two implementations of Saga Pattern: ",(0,i.kt)("strong",{parentName:"p"},"Choreography")," and ",(0,i.kt)("strong",{parentName:"p"},"Orchestration"),". The first one is based on events where\n",(0,i.kt)("strong",{parentName:"p"},"each microservice that is part of the transaction publishes an event that is processed by the next microservice"),". Temporal\nuses Orchestration Pattern. In the Orchestration pattern, ",(0,i.kt)("strong",{parentName:"p"},"a single orchestrator is responsible for managing the overall\ntransaction status"),". If any of the microservice encounters a failure, then the orchestrator is responsible for\ninvoking the necessary compensating transactions. Temporal plays the role of such an orchestrator.")),(0,i.kt)("h3",{id:"write-the-saga"},"Write the Saga"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"class TripBookingWorkflow implements TripBookingWorkflowInterface\n{\n    // ...\n\n    public function bookTrip(string $name)\n    {\n        $saga = new Workflow\\Saga();\n\n        try {\n\n        } catch (\\Throwable $e) {\n\n        }\n    }\n}\n")),(0,i.kt)("p",null,"We start with a new object ",(0,i.kt)("inlineCode",{parentName:"p"},"Workflow\\Saga"),", and then stub out an empty ",(0,i.kt)("inlineCode",{parentName:"p"},"try/catch")," block."),(0,i.kt)("p",null,"Consider everything inside ",(0,i.kt)("inlineCode",{parentName:"p"},"try")," as a happy path. If some steps within a distributed transaction fail, we go into ",(0,i.kt)("inlineCode",{parentName:"p"},"catch")," block and run compensations."),(0,i.kt)("p",null,"Now, let's fill our saga with some logic. First, we add booking steps:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"public function bookTrip(string $name)\n{\n    $saga = new Workflow\\Saga();\n\n    try {\n        $carReservationID = yield $this->activities->reserveCar($name);\n        $hotelReservationID = yield $this->activities->bookHotel($name);\n        $flightReservationID = yield $this->activities->bookFlight($name);\n\n        return [\n            'car' => $carReservationID,\n            'hotel' => $hotelReservationID,\n            'flight' => $flightReservationID\n        ];\n    } catch (\\Throwable $e) {\n\n    }\n}\n")),(0,i.kt)("h3",{id:"add-compensations"},"Add compensations"),(0,i.kt)("p",null,"In the snippet above, we sequentially reserve a car, a hotel, and a flight. Each step here returns a corresponding ID.\nLater we will use this ID to make compensations:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"public function bookTrip(string $name)\n{\n    $saga = new Workflow\\Saga();\n\n    try {\n        $carReservationID = yield $this->activities->reserveCar($name);\n        $saga->addCompensation(fn() => yield $this->activities->cancelCar($carReservationID, $name));\n\n        $hotelReservationID = yield $this->activities->bookHotel($name);\n        $saga->addCompensation(fn() => yield $this->activities->cancelHotel($hotelReservationID, $name));\n\n        $flightReservationID = yield $this->activities->bookFlight($name);\n        $saga->addCompensation(fn() => yield $this->activities->cancelFlight($flightReservationID, $name));\n\n        return [\n            'car' => $carReservationID,\n            'hotel' => $hotelReservationID,\n            'flight' => $flightReservationID\n        ];\n    } catch (\\Throwable $e) {\n\n    }\n}\n")),(0,i.kt)("p",null,"To add a compensation, we use ",(0,i.kt)("inlineCode",{parentName:"p"},"Saga::addCompensation()")," method and provide a callable that should be used, once we want\nto roll back a distributed transaction."),(0,i.kt)("h3",{id:"run-the-compensation-strategy"},"Run the compensation strategy"),(0,i.kt)("p",null,"Having that, we can finish our saga and fill ",(0,i.kt)("inlineCode",{parentName:"p"},"catch")," block:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"public function bookTrip(string $name)\n{\n    $saga = new Workflow\\Saga();\n\n    try {\n        $carReservationID = yield $this->activities->reserveCar($name);\n        $saga->addCompensation(fn() => yield $this->activities->cancelCar($carReservationID, $name));\n\n        $hotelReservationID = yield $this->activities->bookHotel($name);\n        $saga->addCompensation(fn() => yield $this->activities->cancelHotel($hotelReservationID, $name));\n\n        $flightReservationID = yield $this->activities->bookFlight($name);\n        $saga->addCompensation(fn() => yield $this->activities->cancelFlight($flightReservationID, $name));\n\n        return [\n            'car' => $carReservationID,\n            'hotel' => $hotelReservationID,\n            'flight' => $flightReservationID\n        ];\n    } catch (\\Throwable $e) {\n        yield $saga->compensate();\n        throw $e;\n    }\n}\n")),(0,i.kt)("p",null,"Inside ",(0,i.kt)("inlineCode",{parentName:"p"},"catch()")," we call the ",(0,i.kt)("inlineCode",{parentName:"p"},"compensate()")," method, which starts the compensation strategy and runs all previously registered compensation callbacks.\nOnce done, we rethrow the exception to understand what happened."),(0,i.kt)("p",null,"By default, ",(0,i.kt)("strong",{parentName:"p"},"compensations will run sequentially"),". You can tell Saga to run them in parallel by calling ",(0,i.kt)("inlineCode",{parentName:"p"},"$saga->setParallelCompensation(true)"),"."),(0,i.kt)("h2",{id:"conclusion"},"Conclusion"),(0,i.kt)("p",null,"In this tutorial, we covered the Saga architecture pattern to implement distributed transactions in a microservice-based application.\nWriting Sagas correctly can be complex - Temporal allows us to focus only on application details.\nAll the hard work with Saga orchestration: calling microservices and invoking the necessary compensating transactions - is managed by Temporal."),(0,i.kt)("admonition",{title:"Working example",type:"note"},(0,i.kt)("p",{parentName:"admonition"},"We don't cover activity implementation details in this tutorial.\nActivities may be written in different languages, and the main Saga workflow doesn't depend on them.\nIf you want to test things you can find a fully working example in our\n",(0,i.kt)("a",{parentName:"p",href:"https://github.com/temporalio/samples-php/tree/master/app/src/BookingSaga"},"Booking Saga Workflow repo"),".")))}d.isMDXComponent=!0},7356:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/booking-saga-flow-7daa9e250f22382afae6891a610727b3.png"},766:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/banner_php-6b22d4e7d2062dc50defc5f46c25c536.png"}}]);